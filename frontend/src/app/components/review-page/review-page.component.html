<!-- MOBILE MODAL -->
<div
*ngIf="isModalOpen"
class="fixed inset-0 flex flex-col custom-bg-color text-white overflow-y-auto md:hidden z-50"
@slideUp
>
<!--iPod Container -->
<div class="flex flex-col w-full min-h-screen flex-shrink-0 justify-between">
<!--iPod Back -->
    <div
      *ngIf="showSecondIpod"
      [@slideAnimation]="'back'"
      class="relative w-full max-w-lg mx-auto flex flex-col h-full custom-bg-color px-2 overflow-hidden items-center"
    >
      <button
        (click)="showSecondIpod = false"
        class="bg-gray-800 text-white w-16 h-10 rounded-full flex items-center justify-center border-2 border-white mt-3 mb-3"
      >
        <i class="fas fa-arrow-left text-lg"></i>
      </button>

      <h3
        class="record-details-title text-2xl title-text font-bold text-white text-center"
      >
        {{ record.type }} Details
      </h3>

      <div
        #scrollContainer
        [ngClass]="{
          'justify-center': !isScrollable,
          'justify-start': isScrollable
        }"
        class="record-details-card flex-grow overflow-y-auto w-full flex flex-col items-center space-y-10 px-4 pb-4"
        style="min-height: 0; max-height: calc(100svh - 125px)"
              >
        <div
          class="flex flex-col items-center justify-center w-full space-y-10"
        >
          <!-- (Type: Song) Album -->
          <div
            *ngIf="record.type === 'Song'"
            class="flex flex-col items-center"
          >
            <i class="fas fa-compact-disc text-blue-400 pb-2 text-2xl"></i>
            <p class="text-white title-text font-bold text-2xl">Album</p>
            <p class="text-gray-300 text-xl">{{ record.album || "Unknown" }}</p>
          </div>

          <!-- (Type: Song) Release Date -->
          <div
            *ngIf="record.type !== 'Artist'"
            class="flex flex-col items-center"
          >
            <i class="fas fa-calendar-alt text-yellow-400 pb-2 text-2xl"></i>
            <p class="text-white title-text font-bold text-2xl">Release Date</p>
            <p class="text-gray-300 text-xl">
              {{ formatDate(record.releaseDate) }}
            </p>
          </div>

          <!-- (Type: Song) Duration -->
          <div
            *ngIf="record.type === 'Song'"
            class="flex flex-col items-center"
          >
            <i class="fas fa-clock text-red-400 pb-2 text-2xl"></i>
            <p class="text-white title-text font-bold text-2xl">Duration</p>
            <p class="text-gray-300 text-xl">
              {{ formatDuration(record.duration) }}
            </p>
          </div>

          <!-- (Type: Song) Contributors -->
          <div
            *ngIf="record.type === 'Song'"
            class="w-full flex flex-col items-center"
          >
            <i class="fas fa-microphone text-purple-400 pb-2 text-2xl"></i>
            <p class="text-white title-text font-bold text-2xl">Contributors</p>
            <ul class="text-gray-300 title-text text-center text-xl">
              <li *ngFor="let contributor of record.contributors" class="mt-2">
                {{ contributor }}
              </li>
            </ul>
          </div>

          <!-- Album  AND Artist Tracklist -->
          <div *ngIf="record.type !== 'Song'" class="w-full">
            <div class="flex flex-col items-center text-center mb-3">
              <i class="fas fa-music text-blue-400 text-2xl pb-2"></i>
              <p
                *ngIf="record.type === 'Album'"
                class="text-white title-text font-semibold text-2xl"
              >
                Tracklist
              </p>
              <p
                *ngIf="record.type === 'Artist'"
                class="text-white title-text font-semibold text-2xl"
              >
                Top Tracks
              </p>
            </div>
            <ul *ngIf="isTracklistArray" class="space-y-3">
              <li
                *ngFor="let track of record.tracklist; let i = index"
                class="flex items-center justify-between p-3 bg-gray-800 rounded-lg shadow-md"
              >
                <div class="flex items-center gap-3 flex-1 min-w-0 text-xl">
                  <span class="text-gray-400 font-semibold">
                    {{ i + 1 }}
                  </span>
                  <span
                    class="text-white truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0"
                  >
                    {{ track.title }}
                  </span>
                </div>
                <span class="text-gray-300 text-md shrink-0 pl-2.5">
                  {{ formatDuration(track.duration) || "?" }}
                </span>
              </li>
            </ul>

            <p *ngIf="!isTracklistArray" class="text-gray-400 text-center">
              No tracklist available.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!--iPod Front -->
    <div
      *ngIf="!showSecondIpod"
      [@slideAnimation]="'front'"
      class="relative w-full flex flex-col items-center"
    >
      <div class="custom-bg-color pt-2 w-full flex flex-col flex-grow min-h-0">
        <div class="flex justify-between items-center px-4 w-full min-h-[60px]">
          <!-- Left Button -->
          <button
            (click)="showSecondIpod = true"
            class="bg-gray-800 text-white w-[60px] h-[60px] rounded-full flex items-center justify-center border-2 border-white"
          >
            <i class="fa-solid fa-info text-xl"></i>
          </button>

          <!-- Overall Rating Circle -->
          <div
            (click)="scrollToReviews()"
            class="flex justify-center w-full mt-1"
          >
            <div
              class="relative w-32 h-32 md:w-36 md:h-36 lg:w-40 lg:h-40 flex items-center justify-center"
            >
              <ng-container
                *ngIf="
                  !isRatingLoaded ||
                    isDeleteLoading ||
                    isEditLoading ||
                    isCreateLoading;
                  else ratingContentMobile
                "
              >
                <!-- Gray Background & Spinner (Loading State) -->
                <div
                  class="animate-pulse bg-gray-600 rounded-full w-full h-full flex items-center justify-center"
                >
                  <i
                    class="fas fa-spinner fa-spin text-gray-400 text-3xl md:text-4xl lg:text-5xl"
                  ></i>
                </div>
              </ng-container>

              <ng-template #ratingContentMobile>
                <svg
                  width="100%"
                  height="100%"
                  viewBox="0 0 42 42"
                  class="circular-chart absolute w-full h-full"
                >
                  <defs>
                    <linearGradient
                      id="ratingGradientMobile"
                      x1="0%"
                      y1="0%"
                      x2="100%"
                      y2="0%"
                    >
                      <stop
                        offset="0%"
                        style="stop-color: #facc15; stop-opacity: 1"
                      />
                      <stop
                        offset="100%"
                        style="stop-color: #f59e0b; stop-opacity: 1"
                      />
                    </linearGradient>
                  </defs>

                  <!-- Background Circle -->
                  <circle
                    class="circle-bg"
                    cx="21"
                    cy="21"
                    r="18"
                    stroke-width="4"
                    [attr.style]="
                      getAverageRating() === 0 ? 'stroke-opacity: 0;' : ''
                    "
                  />

                  <!-- Foreground Circle (Rating Progress) -->
                  <circle
                    class="circle"
                    cx="21"
                    cy="21"
                    r="18"
                    stroke="url(#ratingGradientMobile)"
                    stroke-width="4"
                    stroke-dasharray="113.1"
                    [attr.stroke-dashoffset]="
                      getAverageRating() > 0
                        ? 113.1 - (getAverageRating() / 10) * 113.1
                        : 113.1
                    "
                    [attr.style]="
                      getAverageRating() === 0 ? 'stroke-opacity: 0;' : ''
                    "
                  />
                </svg>

                <!-- Rating Number, No Reviews, or Spinner -->
                <span
                  class="absolute inset-0 flex flex-col items-center justify-center text-white font-bold text-3xl md:text-4xl lg:text-5xl"
                >
                  <ng-container
                    *ngIf="getAverageRating() > 0; else noReviewsMessage"
                  >
                    <ng-container
                      *ngIf="getAverageRating() === 10; else formattedRating"
                    >
                      10
                    </ng-container>
                    <ng-template #formattedRating>
                      {{ getAverageRating() | number : "1.1-1" }}
                    </ng-template>
                    <span class="text-[1.2rem] font-medium text-gray-300"
                      >/ 10</span
                    >
                  </ng-container>
                </span>
              </ng-template>
            </div>
          </div>

          <!-- No Reviews Star Rating Prompt -->
          <ng-template #noReviewsMessage>
            <div
              class="flex flex-col items-center justify-center text-gray-300"
            >
              <div class="inline-flex space-x-1" (click)="scrollToReviews()">
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
              </div>
              <!-- Ensure only the text is clickable -->
              <span
                class="text-lg font-medium cursor-pointer"
                (click)="scrollToReviews()"
                >Be the first to rate!</span
              >
            </div>
          </ng-template>

          <!-- Close Button -->
          <button
            (click)="close()"
            class="bg-gray-800 text-white w-[60px] h-[60px] rounded-full flex items-center justify-center border-2 border-white"
          >
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>

        <!-- Image Section -->
        <div class="flex flex-col items-center flex-grow justify-center">
          <div
            class="relative max-w-[90%] mt-2 mb-5 flex items-center justify-center"
          >
            <!-- Image (Appears when loaded) -->
            <img
              [src]="record.type === 'Artist' ? record.picture : record.cover"
              [alt]="record.type === 'Artist' ? record.name : record.title"
              class="rounded-lg w-full max-w-[420px] max-h-[420px] object-contain"
              (load)="isImageLoaded = true"
            />
          </div>
        </div>

        <!-- Info-->
        <div class="text-center text-3xl">
          <div
            class="text-gray-200 font-semibold overflow-hidden whitespace-nowrap relative"
          >
            <div
              #scrollingWrapper
              class="scrolling-wrapper"
              [ngClass]="{ 'scroll-active': isTextOverflowing }"
            >
              <div #scrollingContent class="scrolling-content">
                <span
                  *ngIf="record.type != 'Artist'"
                  class="inline-block align-middle"
                >
                  {{ record.title }}
                </span>
                <span *ngIf="record.type == 'Artist'">{{ record.name }}</span>
              </div>
            </div>
          </div>

          <p
            class="text-gray-400 text-xl flex items-center justify-center mt-2"
          >
            <span
              *ngIf="isExplicit"
              class="bg-gray-600 text-white text-lg w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none mr-1"
            >
              E
            </span>
            <span
              class="truncate overflow-hidden whitespace-nowrap max-w-full px-2"
            >
              {{ record.type !== "Artist" ? record.artist : "" }}
            </span>
          </p>
        </div>
        <div
          class="flex-grow flex items-end justify-center"
          style="padding-bottom: env(safe-area-inset-bottom)"
        >
          <app-audio-player
            class="pt-1"
            *ngIf="record.type == 'Song'"
            [record]="record"
            [hidden]="showSecondIpod"
            [showForwardAndBackwardButtons]="showForwardAndBackwardButtons"
            #audioPlayer
            (next)="nextSong()"
            (previous)="prevSong()"
          ></app-audio-player>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div
    #reviewsSection
    *ngIf="!showSecondIpod"
    class="bg-[#252525] p-2 shadow-md w-full mx-auto mt-3"
  >
    <div class="relative mb-2">
      <h2 class="text-2xl font-semibold pt-1 title-text pl-2">
        <i class="fas fas fa-comment-alt text-amber-400 text-xl"></i>
        Reviews
        <span class="text-xl text-gray-500">
          {{
            filteredReviews.length + (existingUserReview ? 1 : 0) > 0
              ? "(" +
                (filteredReviews.length + (existingUserReview ? 1 : 0)) +
                ")"
              : ""
          }}
        </span>
      </h2>
      <div
        *ngIf="!existingUserReview && !isAddingReview && isReviewsLoaded"
        class="absolute right-0 top-0"
      >
        <button
          (click)="toggleReviewForm()"
          class="flex items-center gap-1 bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded font-medium transition text-xl"
        >
          <i class="fas fa-plus-circle text-xl"></i>
          <span>Add</span>
        </button>
      </div>
    </div>

    <div>
      <ng-container *ngIf="!isReviewsLoaded; else reviewsContentMobile">
        <div class="space-y-3 mt-3">
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
        </div>
      </ng-container>

      <ng-template #reviewsContentMobile>
        <!-- Fullscreen Overlay -->
        <div
          *ngIf="isAddingReview"
          class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center"
        >
          <!-- Review Card -->
          <div
            class="w-[100vh] bg-[#3a3a3a] p-6 shadow-lg h-[100vh] flex flex-col justify-between"
          >
            <!-- Title -->
            <p class="text-white font-semibold text-4xl mb-4 text-center">
              <i class="fas fa-comments text-indigo-400 text-indigo-400"></i>
              Feedback
            </p>
            <!-- Rating and Textarea Container -->
            <div class="flex flex-col items-center justify-center flex-grow">
              <!-- Star Rating Display -->
              <div class="flex justify-center mb-4">
                <ng-container
                  *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                >
                  <ng-container [ngSwitch]="getStarType(star, newRating)">
                    <i
                      *ngSwitchCase="'full'"
                      class="fas fa-star text-3xl text-yellow-400"
                    ></i>
                    <i
                      *ngSwitchCase="'half'"
                      class="fas fa-star-half-alt text-3xl text-yellow-400"
                    ></i>
                    <i
                      *ngSwitchCase="'empty'"
                      class="far fa-star text-3xl text-gray-500"
                    ></i>
                  </ng-container>
                </ng-container>
              </div>
              <!-- Rating -->
              <div class="text-center mb-4 w-full">
                <p class="text-white font-medium text-3xl mb-2">
                  Rating:
                  <input
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    [(ngModel)]="newRating"
                    (keypress)="onKeyPressRating($event, 'new')"
                    (blur)="onBlurRating('new')"
                    class="w-[3.4rem] text-3xl leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                  />
                  <span
                    class="text-yellow-300 text-2xl opacity-70 font-medium ml-1"
                    >/10</span
                  >
                </p>

                <input
                  type="range"
                  min="0"
                  max="10"
                  step="0.1"
                  [(ngModel)]="newRating"
                  class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                />
              </div>

              <!-- Review Textarea -->
              <textarea
                class="w-full p-3 text-xl bg-gray-800 rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-blue-500 h-[50vh]"
                placeholder="Write your review here..."
                [(ngModel)]="newReview"
              ></textarea>
            </div>

            <!-- Buttons -->
            <div class="flex gap-2 mt-4 font-medium">
              <button
                class="bg-red-600 text-white text-2xl px-4 py-4 rounded-lg w-full flex items-center justify-center gap-2"
                (click)="cancelReview()"
              >
                <i class="fa fa-times"></i> Cancel
              </button>
              <button
                (click)="submitReview()"
                class="bg-indigo-500 hover:bg-indigo-600 text-2xl px-4 py-2 rounded-lg text-white w-full flex items-center justify-center gap-2"
              >
                <ng-container *ngIf="!isCreateLoading">
                  <i class="fas fa-paper-plane"></i> Create
                </ng-container>
                <ng-container *ngIf="isCreateLoading">
                  <i class="fas fa-spinner fa-spin"></i> Creating
                </ng-container>
              </button>
            </div>
          </div>
        </div>
        <!-- Existing User Review Section -->
        <ng-container *ngIf="!isDeleteLoading; else deletingReviewLoaderMobile">
          <div *ngIf="existingUserReview" class="mt-3" @fadeIn>
            <ul class="space-y-2">
              <li
                class="review-card p-3 rounded-lg flex flex-col gap-2 relative bg-gray-900"
              >
                <!-- Edit & Delete Buttons -->
                <button
                  *ngIf="!isEditingReview"
                  (click)="toggleEditReview(existingUserReview)"
                  class="absolute top-2 left-3 text-gray-400 hover:text-indigo-400 transition"
                >
                  <i class="fas fa-edit text-2xl"></i>
                </button>
                <button
                  *ngIf="!isEditingReview"
                  (click)="deleteReview(existingUserReview)"
                  class="absolute top-2 right-3 text-gray-400 hover:text-red-500 transition"
                >
                  <i class="fas fa-trash text-2xl"></i>
                </button>

                <!-- Fullscreen Overlay for Editing -->
                <div
                  *ngIf="isEditingReview"
                  class="fixed inset-0 bg-black z-50 flex items-center justify-center"
                >
                  <div
                    class="w-full bg-[#3a3a3a] p-6 shadow-lg h-full flex flex-col justify-between"
                  >
                    <!-- Header -->
                    <p
                      class="text-white font-semibold text-4xl mb-4 text-center flex items-center justify-center gap-2"
                    >
                      <i class="fas fa-edit text-indigo-400"></i>
                      Editing Review
                    </p>
                    <!-- Edit Rating Section -->
                    <div
                      class="flex flex-col items-center justify-center flex-grow"
                    >
                      <div class="text-center w-full mx-auto">
                        <!-- Star Rating Display -->
                        <div class="flex justify-center mb-4">
                          <ng-container
                            *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                          >
                            <ng-container
                              [ngSwitch]="getStarType(star, editedRating)"
                            >
                              <i
                                *ngSwitchCase="'full'"
                                class="fas fa-star text-3xl text-yellow-400"
                              ></i>
                              <i
                                *ngSwitchCase="'half'"
                                class="fas fa-star-half-alt text-3xl text-yellow-400"
                              ></i>
                              <i
                                *ngSwitchCase="'empty'"
                                class="far fa-star text-3xl text-gray-500"
                              ></i>
                            </ng-container>
                          </ng-container>
                        </div>

                        <p class="text-white font-medium text-3xl mb-2">
                          Rating:
                          <input
                            type="number"
                            min="0"
                            max="10"
                            step="0.1"
                            [(ngModel)]="editedRating"
                            (keypress)="onKeyPressRating($event, 'edit')"
                            (blur)="onBlurRating('edit')"
                            class="w-[3.4rem] text-3xl leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                          />
                          <span
                            class="text-yellow-300 text-2xl opacity-70 font-medium ml-1"
                            >/10</span
                          >
                        </p>

                        <!-- Slider Control -->
                        <input
                          type="range"
                          min="0"
                          max="10"
                          step="0.1"
                          [(ngModel)]="editedRating"
                          class="w-full h-3 rounded-full bg-gray-700 appearance-none cursor-pointer transition-all slider-modern"
                        />
                      </div>

                      <!-- Review Text -->
                      <textarea
                        [(ngModel)]="editedReviewText"
                        class="w-full mt-5 p-3 text-xl bg-gray-800 rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-blue-500 h-[50vh]"
                        placeholder="Write your review here..."
                      ></textarea>
                    </div>
                    <!-- Buttons -->
                    <div class="flex gap-2 mt-4 font-medium">
                      <button
                        class="bg-red-600 text-white text-2xl px-4 py-4 rounded-lg w-full flex items-center justify-center gap-2"
                        (click)="cancelEditReview()"
                      >
                        <i class="fa fa-times"></i> Cancel
                      </button>
                      <button
                        (click)="submitEditReview()"
                        class="bg-green-500 hover:bg-green-600 text-2xl px-4 py-2 rounded-lg text-white w-full flex items-center justify-center gap-2"
                      >
                        <ng-container *ngIf="!isCreateLoading">
                          <i class="fas fa-save"></i> Save
                        </ng-container>
                        <ng-container *ngIf="isCreateLoading">
                          <i class="fas fa-spinner fa-spin"></i> Saving
                        </ng-container>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Display Rating Bubble when NOT Editing -->
                <p
                  *ngIf="!isEditingReview"
                  [ngStyle]="{
                    background: getRatingBackground(existingUserReview.rating)
                  }"
                  class="rating-bubble mx-auto text-white rounded-full px-2 py-1 text-lg"
                >
                  <i class="fas fa-star"></i>
                  {{ existingUserReview.rating }} / 10
                </p>

                <!-- Review Text -->
                <div class="text-center w-full mt-4">
                  <p
                    *ngIf="!isEditingReview"
                    class="text-gray-300 text-xl break-words"
                  >
                    {{ existingUserReview.reviewText }}
                  </p>
                  <p
                    *ngIf="!isEditingReview"
                    class="text-gray-400 text-xl mt-3 font-medium text-center"
                  >
                    {{ existingUserReview.user.username }} (Your Review)
                  </p>
                </div>
              </li>
            </ul>
          </div>
        </ng-container>

        <ng-template #deletingReviewLoaderMobile>
          <div
            class="flex items-center justify-center h-16 bg-gray-800 rounded-lg p-4"
          >
            <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
            <span class="ml-2 text-gray-300 text-lg">Deleting...</span>
          </div>
        </ng-template>
        <!-- All Reviews Section -->
        <div>
          <ng-container
            *ngIf="
              existingUserReview || filteredReviews.length > 0;
              else noReviewsMobile
            "
          >
            <ul class="space-y-4 mt-3" @fadeIn>
              <li
                *ngFor="let review of filteredReviews; trackBy: trackById"
                class="review-card p-3 rounded-lg flex flex-col gap-2"
              >
                <p
                  [ngStyle]="{ background: getRatingBackground(review.rating) }"
                  class="rating-bubble mx-auto text-white text-lg rounded-full px-2 py-1"
                >
                  <i class="fas fa-star"></i> {{ review.rating }} / 10
                </p>
                <div class="text-center mt-4">
                  <p class="text-gray-300 text-xl break-words">
                    {{ review.reviewText }}
                  </p>
                  <p class="text-gray-400 text-xl mt-3 font-medium text-center">
                    {{ review.user.username }}
                  </p>
                </div>
              </li>
            </ul>
          </ng-container>
          <ng-template #noReviewsMobile>
            <p class="text-gray-400 mt-8 text-center text-xl">
              No reviews available.
            </p>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- SEPARATION OF THE MODALS -->

<!-- DESKTOP/TABLET MODAL -->
<div
  *ngIf="isModalOpen"
  class="hidden md:flex min-h-[90vh] fixed inset-0 items-center justify-center bg-black bg-opacity-50 overflow-y-auto custom-scrollbar z-50"
>
  <div
    class="relative bg-[#1E1E1E] text-white md:w-[90%] xl:w-[85%] 2xl:w-[75%] sm:rounded-xl shadow-lg p-3 flex flex-col overflow-y-auto custom-scrollbar min-h-[90vh] max-h-[90vh]"
  >
    <!-- Exit Button -->
    <button
      (click)="close()"
      class="absolute top-3 right-3 bg-gray-800 hover:bg-gray-700 text-white w-12 h-12 rounded-full flex items-center justify-center transition border-2 border-white shadow-lg"
    >
      <i class="fas fa-times text-xl"></i>
    </button>

    <!-- Overall Rating Circle -->
    <div class="flex justify-center w-full">
      <ng-container
        *ngIf="
          !isRatingLoaded ||
            isCreateLoading ||
            isEditLoading ||
            isDeleteLoading;
          else ratingContentDesktop
        "
      >
        <!-- Loading State (Spinner) -->
        <div
          class="animate-pulse bg-gray-600 rounded-full w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <i
            class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
          ></i>
        </div>
      </ng-container>

      <ng-template #ratingContentDesktop>
        <div
          class="relative w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <svg
            width="100%"
            height="100%"
            viewBox="0 0 42 42"
            class="circular-chart absolute w-full h-full"
          >
            <defs>
              <linearGradient
                id="ratingGradientDesktop"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop
                  offset="0%"
                  style="stop-color: #facc15; stop-opacity: 1"
                />
                <stop
                  offset="100%"
                  style="stop-color: #f59e0b; stop-opacity: 1"
                />
              </linearGradient>
            </defs>

            <!-- Background Circle -->
            <circle
              class="circle-bg"
              cx="21"
              cy="21"
              r="18"
              stroke-width="4"
              [attr.style]="
                isRatingLoaded &&
                !isDeleteLoading &&
                !isEditLoading &&
                !isCreateLoading &&
                getAverageRating() === 0
                  ? 'stroke-opacity: 0;'
                  : ''
              "
            />

            <!-- Foreground Circle (Rating Progress) -->
            <circle
              class="circle"
              cx="21"
              cy="21"
              r="18"
              stroke="url(#ratingGradientDesktop)"
              stroke-width="4"
              stroke-dasharray="113.1"
              [attr.stroke-dashoffset]="
                getAverageRating() > 0
                  ? 113.1 - (getAverageRating() / 10) * 113.1
                  : 113.1
              "
              [attr.style]="
                getAverageRating() === 0 ? 'stroke-opacity: 0;' : ''
              "
            />
          </svg>

          <!-- Rating Display OR No Reviews Message -->
          <span
            class="absolute inset-0 flex flex-col items-center justify-center text-white font-bold text-2xl md:text-3xl lg:text-4xl"
          >
            <ng-container
              *ngIf="
                isRatingLoaded &&
                  !isDeleteLoading &&
                  !isEditLoading &&
                  !isCreateLoading;
                else loadingSpinner
              "
            >
              <ng-container
                *ngIf="getAverageRating() > 0; else noReviewsMessage"
              >
                <ng-container
                  *ngIf="getAverageRating() === 10; else formattedRating"
                >
                  10
                </ng-container>
                <ng-template #formattedRating>
                  {{ getAverageRating() | number : "1.1-1" }}
                </ng-template>
                <span class="text-xs md:text-sm font-medium text-gray-300"
                  >/ 10</span
                >
              </ng-container>
            </ng-container>
          </span>
        </div>
      </ng-template>
    </div>

    <!-- No Reviews: Show Star Rating Prompt -->
    <ng-template #noReviewsMessage>
      <div class="flex flex-col items-center justify-center text-gray-400">
        <div class="flex space-x-1">
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
        </div>
        <span class="text-lg font-medium">Be the first to rate!</span>
      </div>
    </ng-template>

    <!-- Small Loader Inside Circle -->
    <ng-template #loadingSpinner>
      <div class="animate-pulse flex items-center justify-center">
        <i
          class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
        ></i>
      </div>
    </ng-template>

    <div class="flex-1 flex flex-col overflow-auto custom-scrollbar pr-2">
      <!-- Two-Column Layout -->
      <div class="flex flex-col md:flex-row items-start gap-4 mt-2">
        <!-- Wrapper for both iPods -->
        <div
          class="relative w-[32vw] min-w-[200px] max-w-[300px] min-h-[500px] overflow-auto overflow-hidden"
        >
          <!-- First iPod -->
          <div
            class="relative transition-transform duration-500"
            [@iPodTransition]="iPodState"
          >
            <div
              class="custom-bg-color border border-gray-700 rounded-lg p-3 md:p-4 w-full overflow-hidden"
            >
              <div class="flex flex-col h-full">
                <!-- Image Area -->
                <div
                  class="relative flex-1 flex items-center justify-center w-full min-h-[200px] max-h-[60vh]"
                >
                  <!-- Image Wrapper (Matches Mobile Structure) -->
                  <div
                    class="relative w-full aspect-square flex items-center justify-center overflow-hidden rounded-lg"
                  >
                    <!-- Skeleton Loader -->
                    <div
                      *ngIf="!isImageLoaded"
                      class="absolute inset-0 flex items-center justify-center bg-gray-700 skeleton-wave rounded-lg"
                    ></div>

                    <!-- Actual Image (Fixed) -->
                    <img
                      *ngIf="isImageLoaded"
                      [src]="
                        record.type === 'Artist' ? record.picture : record.cover
                      "
                      [alt]="
                        record.type === 'Artist' ? record.name : record.title
                      "
                      (click)="showSecondIpod = true"
                      class="w-full h-full object-contain rounded-lg cursor-pointer transition-transform duration-300 ease-in-out hover:opacity-80"
                    />
                  </div>
                </div>

                <!-- Info and Audio Player -->
                <div class="mt-4 text-center">
                  <p
                    class="text-gray-200 text-2xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span
                      *ngIf="record.type != 'Artist'"
                      class="inline-block align-middle"
                    >
                      {{ record.title }}
                    </span>
                    <span *ngIf="record.type == 'Artist'">{{
                      record.name
                    }}</span>
                  </p>
                  <p class="text-gray-400 text-lg">
                    <span
                      *ngIf="isExplicit"
                      class="inline-flex items-center justify-center bg-gray-600 text-white text-[10px] mr-1 font-bold w-5 h-5 px-[1px] rounded leading-none align-middle"
                      title="Explicit"
                    >
                      E
                    </span>
                    {{ record.type !== "Artist" ? record.artist : "" }}
                  </p>
                  <app-audio-player
                    *ngIf="record.type == 'Song'"
                    [record]="record"
                    [showForwardAndBackwardButtons]="
                      showForwardAndBackwardButtons
                    "
                    #audioPlayer
                    (playStatus)="updatePlayStatus($event)"
                    (next)="nextSong()"
                    (previous)="prevSong()"
                  ></app-audio-player>
                </div>
              </div>
            </div>
          </div>

          <!-- Back of iPod (Desktop) -->
          <div
            class="absolute top-0 left-0 w-full h-full flex transition-transform duration-500"
            [@fadeInContent]="contentState"
            [ngStyle]="{ 'pointer-events': showSecondIpod ? 'auto' : 'none' }"
          >
            <div
              class="custom-bg-color rounded-lg px-2 pb-4 w-full flex flex-col h-full max-h-[80vh] overflow-y-auto custom-scrollbar items-center"
            >
              <!-- Close Button -->
              <button
                (click)="showSecondIpod = false"
                class="bg-gray-800 text-white w-16 h-16 rounded-full flex items-center justify-center border-2 border-white mt-3 mb-3"
              >
                <i class="fas fa-arrow-left text-lg"></i>
              </button>

              <h3
                class="record-details-title text-xl title-text font-bold text-white text-center"
              >
                {{ record.type }} Details
              </h3>

              <!-- Details Container -->
              <div
                class="record-details-card flex-grow overflow-y-auto w-full max-h-[80vh] flex flex-col items-center space-y-10 px-4 pb-4 custom-scrollbar"
              >
                <!-- (Type: Song) Album -->
                <div
                  *ngIf="record.type === 'Song'"
                  class="flex flex-col items-center text-center w-full"
                >
                  <i class="fas fa-compact-disc text-blue-400 pb-2 text-lg"></i>
                  <p class="text-white title-text font-bold text-lg">Album</p>
                  <p
                    class="text-gray-300 text-xl break-words text-center max-w-[80%]"
                  >
                    {{ record.album || "Unknown" }}
                  </p>
                </div>

                <!-- (Type: Song) Release Date -->
                <div
                  *ngIf="record.type !== 'Artist'"
                  class="flex flex-col items-center"
                >
                  <i
                    class="fas fa-calendar-alt text-yellow-400 pb-2 text-lg"
                  ></i>
                  <p class="text-white title-text font-bold text-lg">
                    Release Date
                  </p>
                  <p class="text-gray-300 text-xl">
                    {{ formatDate(record.releaseDate) }}
                  </p>
                </div>

                <!-- (Type: Song) Duration -->
                <div
                  *ngIf="record.type === 'Song'"
                  class="flex flex-col items-center"
                >
                  <i class="fas fa-clock text-red-400 pb-2 text-lg"></i>
                  <p class="text-white title-text font-bold text-lg">
                    Duration
                  </p>
                  <p class="text-gray-300 text-xl">
                    {{ formatDuration(record.duration) }}
                  </p>
                </div>

                <!-- (Type: Song) Contributors -->
                <div
                  *ngIf="record.type === 'Song'"
                  class="w-full flex flex-col items-center"
                >
                  <i class="fas fa-microphone text-purple-400 pb-2 text-lg"></i>
                  <p class="text-white title-text font-bold text-lg">
                    Contributors
                  </p>
                  <ul class="text-gray-300 title-text text-center text-xl">
                    <li
                      *ngFor="let contributor of record.contributors"
                      class="mt-2"
                    >
                      {{ contributor }}
                    </li>
                  </ul>
                </div>

                <!-- Album and Artist Tracklist -->
                <div *ngIf="record.type !== 'Song'" class="w-full">
                  <div class="flex flex-col items-center text-center mb-3">
                    <i class="fas fa-music text-blue-400 text-lg pb-2"></i>
                    <p
                      *ngIf="record.type === 'Album'"
                      class="text-white title-text font-semibold text-lg"
                    >
                      Tracklist
                    </p>
                    <p
                      *ngIf="record.type === 'Artist'"
                      class="text-white title-text font-semibold text-lg"
                    >
                      Top Tracks
                    </p>
                  </div>

                  <ul class="space-y-3">
                    <li
                      *ngFor="let track of record.tracklist; let i = index"
                      class="flex items-center justify-between p-3 bg-gray-800 rounded-lg shadow-md w-full"
                    >
                      <div class="flex items-center gap-2 flex-1 min-w-0">
                        <span class="text-gray-400 font-semibold text-md">
                          {{ i + 1 }}
                        </span>
                        <span
                          class="text-white title-text truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0"
                        >
                          {{ track.title }}
                        </span>
                      </div>
                      <span class="text-gray-300 text-sm shrink-0 pl-2">
                        {{ formatDuration(track.duration) || "?" }}
                      </span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Reviews section -->
        <div class="w-full md:w-2/3">
          <div
            class="bg-[#252525] p-3 rounded-xl shadow-md w-full h-[70vh] flex flex-col"
          >
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h3 class="font-semibold pb-2 title-text text-2xl">
                <i class="fas fas fa-comment-alt text-amber-400 text-xl"></i>
                Reviews
                <span class="text-xl text-gray-500">
                  {{
                    filteredReviews.length + (existingUserReview ? 1 : 0) > 0
                      ? "(" +
                        (filteredReviews.length +
                          (existingUserReview ? 1 : 0)) +
                        ")"
                      : ""
                  }}
                </span>
              </h3>
              <div
                *ngIf="
                  !existingUserReview && !isAddingReview && isReviewsLoaded
                "
              >
                <button
                  (click)="toggleReviewForm()"
                  class="flex items-center gap-1 bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-lg font-medium transition text-xl"
                >
                  <i class="fas fa-plus-circle text-xl"></i>
                  <span>Add Review</span>
                </button>
              </div>
            </div>
            <div class="custom-scrollbar h-[70vh] overflow-y-auto pr-2">
              <!-- Loading Indicator for Reviews -->
              <ng-container *ngIf="!isReviewsLoaded; else reviewsContent">
                <div class="space-y-3 mt-3">
                  <div
                    class="animate-pulse bg-gray-700 p-4 rounded-lg h-20"
                  ></div>
                  <div
                    class="animate-pulse bg-gray-700 p-4 rounded-lg h-20"
                  ></div>
                  <div
                    class="animate-pulse bg-gray-700 p-4 rounded-lg h-20"
                  ></div>
                </div>
              </ng-container>

              <ng-template #reviewsContent>
                <div
                  *ngIf="isAddingReview"
                  class="mt-2 p-4 bg-[#2F2F2F] rounded-lg flex flex-col justify-between h-full"
                >
                  <!-- Header -->
                  <p class="text-white font-semibold text-3xl mb-4 text-center">
                    <i
                      class="fas fa-comments text-indigo-400 text-indigo-400"
                    ></i>
                    Feedback
                  </p>

                  <!-- Rating Section -->
                  <div class="w-full text-center mb-4">
                    <!-- Star Rating Display -->
                    <div class="flex justify-center mb-4">
                      <ng-container
                        *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                      >
                        <ng-container [ngSwitch]="getStarType(star, newRating)">
                          <i
                            *ngSwitchCase="'full'"
                            class="fas fa-star text-3xl text-yellow-400"
                          ></i>
                          <i
                            *ngSwitchCase="'half'"
                            class="fas fa-star-half-alt text-3xl text-yellow-400"
                          ></i>
                          <i
                            *ngSwitchCase="'empty'"
                            class="far fa-star text-3xl text-gray-500"
                          ></i>
                        </ng-container>
                      </ng-container>
                    </div>
                    <p class="text-white font-medium text-2xl mb-2">
                      Rating:
                      <input
                        type="number"
                        min="0"
                        max="10"
                        step="0.1"
                        [(ngModel)]="newRating"
                        (keypress)="onKeyPressRating($event, 'new')"
                        (blur)="onBlurRating('new')"
                        class="w-[3.2rem] text-2xl leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                      />
                      <span
                        class="text-yellow-300 text-lg opacity-70 font-medium ml-1"
                        >/10</span
                      >
                    </p>

                    <!-- Slider -->
                    <input
                      type="range"
                      min="0"
                      max="10"
                      step="0.1"
                      [(ngModel)]="newRating"
                      class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                    />
                  </div>
                  <textarea
                    class="w-full p-3 bg-gray-800 rounded-lg text-gray-300 placeholder-gray-500 text-xl h-[35vh]"
                    placeholder="Write your review here..."
                    [(ngModel)]="newReview"
                  ></textarea>
                  <div class="flex gap-2 mt-4 font-medium">
                    <button
                      class="bg-red-600 hover:bg-red-700 text-white text-2xl px-4 py-4 rounded-lg w-full flex items-center justify-center gap-2"
                      (click)="cancelReview()"
                    >
                      <i class="fas fa-times"></i> Cancel
                    </button>
                    <button
                      (click)="submitReview()"
                      class="bg-indigo-600 hover:bg-indigo-700 text-2xl px-4 py-2 rounded-lg text-white w-full flex items-center justify-center gap-2"
                    >
                      <span *ngIf="!isCreateLoading"
                        ><i class="fas fa-paper-plane"></i> Create</span
                      >
                      <span
                        *ngIf="isCreateLoading"
                        class="flex items-center gap-2"
                      >
                        <i class="fas fa-spinner fa-spin"></i>
                        Creating
                      </span>
                    </button>
                  </div>
                </div>
                <!-- Exisitng user review section -->
                <ng-container
                  *ngIf="!isDeleteLoading; else deletingReviewLoader"
                >
                  <div *ngIf="existingUserReview" class="mt-3" @fadeIn>
                    <ul class="space-y-2 sm:space-y-3">
                      <li
                        class="review-card p-3 rounded-lg flex flex-col gap-3 relative bg-gray-900"
                      >
                        <!-- Edit & Delete Icons (Hidden when editing) -->
                        <button
                          *ngIf="!isEditingReview"
                          (click)="toggleEditReview(existingUserReview)"
                          class="absolute top-2 left-3 text-gray-400 hover:text-indigo-400 transition"
                        >
                          <i class="fas fa-edit text-2xl"></i>
                        </button>

                        <button
                          *ngIf="!isEditingReview"
                          (click)="deleteReview(existingUserReview)"
                          class="absolute top-2 right-3 text-gray-400 hover:text-red-500 transition"
                        >
                          <i class="fas fa-trash text-2xl"></i>
                        </button>

                        <!-- Rating Section -->
                        <div
                          *ngIf="isEditingReview"
                          class="w-full text-center mb-2"
                        >
                          <!-- Header -->
                          <p
                            class="text-white font-semibold text-2xl mb-4 text-center"
                          >
                            <i class="fas fa-edit text-indigo-400"></i>
                            Editing Review
                          </p>
                          <!-- Star Rating Display -->
                          <div class="flex justify-center mb-4">
                            <ng-container
                              *ngFor="
                                let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                              "
                            >
                              <ng-container
                                [ngSwitch]="getStarType(star, editedRating)"
                              >
                                <i
                                  *ngSwitchCase="'full'"
                                  class="fas fa-star text-3xl text-yellow-400"
                                ></i>
                                <i
                                  *ngSwitchCase="'half'"
                                  class="fas fa-star-half-alt text-3xl text-yellow-400"
                                ></i>
                                <i
                                  *ngSwitchCase="'empty'"
                                  class="far fa-star text-3xl text-gray-500"
                                ></i>
                              </ng-container>
                            </ng-container>
                          </div>
                          <p class="text-white font-medium text-2xl mb-2">
                            Rating:
                            <input
                              type="number"
                              min="0"
                              max="10"
                              step="0.1"
                              [(ngModel)]="editedRating"
                              (keypress)="onKeyPressRating($event, 'new')"
                              (blur)="onBlurRating('new')"
                              class="w-[3.2rem] text-2xl leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                            />
                            <span
                              class="text-yellow-300 text-lg opacity-70 font-medium"
                              >/10</span
                            >
                          </p>

                          <input
                            type="range"
                            min="0"
                            max="10"
                            step="0.1"
                            [(ngModel)]="editedRating"
                            class="w-full h-3 rounded-full bg-gray-700 appearance-none cursor-pointer transition-all slider-modern"
                          />
                        </div>

                        <!-- Rating Bubble (Hidden when editing) -->
                        <p
                          *ngIf="!isEditingReview"
                          [ngStyle]="{
                            background: getRatingBackground(
                              existingUserReview.rating
                            )
                          }"
                          class="rating-bubble mx-auto text-white"
                        >
                          <i class="fas fa-star"></i>
                          {{ existingUserReview.rating }} / 10
                        </p>

                        <div class="text-left w-full">
                          <!-- Editable TextArea when Editing -->
                          <textarea
                            *ngIf="isEditingReview"
                            [(ngModel)]="editedReviewText"
                            class="text-gray-300 text-xl break-words w-full bg-gray-800 rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="7"
                            placeholder="Write your review here..."
                          ></textarea>

                          <!-- Normal Review Display -->
                          <p
                            *ngIf="!isEditingReview"
                            class="text-gray-300 text-xl break-words text-center mt-3"
                          >
                            {{ existingUserReview.reviewText }}
                          </p>

                          <!-- Hide Username when Editing -->
                          <p
                            *ngIf="!isEditingReview"
                            class="text-gray-400 text-xl mt-3 font-medium text-center"
                          >
                            {{ existingUserReview.user.username }} (Your Review)
                          </p>
                        </div>

                        <!-- Submit & Cancel Buttons -->
                        <div
                          *ngIf="isEditingReview"
                          class="flex gap-2 mt-4 font-medium"
                        >
                          <button
                            (click)="cancelEditReview()"
                            [disabled]="isEditLoading"
                            class="bg-red-600 hover:bg-red-700 text-white text-2xl px-4 py-4 rounded-lg w-full flex items-center justify-center gap-2"
                          >
                            <i class="fas fa-times"></i> Cancel
                          </button>

                          <button
                            (click)="submitEditReview()"
                            [disabled]="isEditLoading"
                            class="bg-green-600 hover:bg-green-700 text-2xl px-4 py-2 rounded-lg text-white w-full flex items-center justify-center gap-2"
                          >
                            <span *ngIf="!isEditLoading">
                              <i class="fas fa-save"></i> Save
                            </span>
                            <span
                              *ngIf="isEditLoading"
                              class="flex items-center gap-2"
                            >
                              <i class="fas fa-spinner fa-spin"></i>
                              Saving
                            </span>
                          </button>
                        </div>
                      </li>
                    </ul>
                  </div>
                </ng-container>
                <!-- Loader (Replaces User's Review While Deleting) -->
                <ng-template #deletingReviewLoader>
                  <div
                    class="flex items-center justify-center h-20 bg-gray-800 rounded-lg p-4"
                  >
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <span class="ml-2 text-gray-300 text-lg">Deleting...</span>
                  </div>
                </ng-template>

                <!-- All Reviews Section -->
                <div class="max-h-full" @fadeIn>
                  <ng-container
                    *ngIf="
                      existingUserReview || filteredReviews.length > 0;
                      else noReviews
                    "
                  >
                    <ul class="space-y-4 mt-3">
                      <li
                        *ngFor="
                          let review of filteredReviews;
                          trackBy: trackById
                        "
                        class="review-card p-3 sm:p-4 rounded-lg flex flex-col gap-3"
                      >
                        <!-- Centered Rating -->
                        <p
                          [ngStyle]="{
                            background: getRatingBackground(review.rating)
                          }"
                          class="rating-bubble mx-auto text-white"
                        >
                          <i class="fas fa-star"></i> {{ review.rating }} / 10
                        </p>

                        <!-- Review Text Below -->
                        <div class="text-left mt-3">
                          <p
                            class="text-gray-300 text-xl break-words text-center"
                          >
                            {{ review.reviewText }}
                          </p>
                          <p
                            class="text-gray-400 text-xl mt-3 font-medium text-center"
                          >
                            {{ review.user.username }}
                          </p>
                        </div>
                      </li>
                    </ul>
                    <div class="h-3"></div>
                  </ng-container>
                </div>
              </ng-template>

              <ng-template #noReviews>
                <p class="text-gray-400 italic mt-10 text-2xl">
                  No reviews available.
                </p>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
