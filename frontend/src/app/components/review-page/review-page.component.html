<!-- MOBILE MODAL -->
<div
  *ngIf="isModalOpen"
  class="fixed inset-0 flex flex-col bg-[#09101F] text-white overflow-y-auto md:hidden z-50"
  @slideUp
>
  <!--iPod Container -->
  <div
    class="flex flex-col w-full flex-shrink-0 justify-between"
    style="height: 100dvh"
  >
    <!--iPod Back -->
    <div
      [@slideAnimation]="showSecondIpod ? 'back' : 'hidden'"
      [ngClass]="{ 'invisible-view': !showSecondIpod }"
      *ngIf="showSecondIpod"
    >
      <!-- Back Button (top-left) -->
      <button
        (click)="onBackClick()"
        class="absolute top-4 left-4 w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-md z-50"
      >
        <i class="fas fa-chevron-left text-[#09101F] text-lg"></i>
      </button>

      <!-- Artist Section -->
      <div *ngIf="record.type === 'Artist'">
        <!-- Image background layer -->
        <div class="absolute top-0 left-0 right-0 w-full z-0">
          <img
            [src]="record.type === 'Artist' ? record.picture : ''"
            class="w-full h-auto"
            alt="Record Image"
          />
          <div class="absolute inset-0 bg-black/40"></div>
        </div>
        <div class="relative mt-[10rem] left-0 right-0 px-2 py-2 z-50">
          <div class="bg-white/30 rounded-md p-3 w-full text-left">
            <p *ngIf="record.type === 'Artist'" class="text-xl font-semibold">
              Top Tracks
            </p>
          </div>
          <!-- Album Tracklist -->
          <ul
            *ngIf="isTracklistArray"
            class="space-y-3 w-full mt-3 p-2 rounded-lg"
          >
            <li
              *ngFor="let track of record.tracklist; let i = index"
              class="flex items-center justify-between py-4 pr-4 pl-2 bg-[#09101F] rounded-xl transition-all duration-300 border border-[#142249]"
              [ngClass]="{
                'opacity-50': !track.preview || track.preview.length <= 1,
                'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
              }"
            >
              <!-- Play Button -->
              <ng-container *ngIf="track.preview && track.preview.length > 1">
                <div
                  class="flex items-center justify-center w-12 h-12 bg-[#1F273A] text-white rounded-full mr-3 px-3 transition-all duration-300"
                  [ngClass]="{
                    'transition-all duration-300 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                      track.isPlaying
                  }"
                  (click)="playTrack(track)"
                >
                  <i
                    [ngClass]="{
                      fas: true,
                      'fa-pause': track.isPlaying,
                      'fa-play': !track.isPlaying
                    }"
                    class="text-lg transition-all duration-300"
                  >
                  </i>
                </div>
              </ng-container>

              <!-- Title and album info -->
              <div
                class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
              >
                <div class="flex items-center gap-2 min-w-0 text-xl">
                  <span
                    (click)="openSong(track)"
                    class="text-white text-base truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                  >
                    <span
                      *ngIf="track.isExplicit"
                      class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                    >
                      E
                    </span>
                    <span
                      class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                      >{{ track.title }}</span
                    >
                  </span>
                </div>
                <div
                  (click)="openSong(track)"
                  class="flex items-center gap-2 text-gray-400 text-sm"
                >
                  <span
                    class="truncate overflow-hidden whitespace-nowrap block flex-1"
                    [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                  >
                    Album: <span class="pl-2">{{ track.album }}</span>
                  </span>
                </div>
              </div>

              <!-- Duration -->
              <span
                (click)="openSong(track)"
                class="text-gray-300 bg-[#172438] text-base shrink-0 ml-2.5 p-1 px-1.5 rounded-md"
              >
                {{ formatDuration(track.duration) || "?" }}
              </span>
            </li>
          </ul>

          <!-- Loading state -->
          <div
            *ngIf="isLoadingExtraDetails"
            class="w-full bg-[#09101F] p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
          >
            <p class="text-gray-400 text-center mb-4">Loading tracklist...</p>
            <div
              class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
            ></div>
          </div>

          <!-- No tracklist -->
          <div
            *ngIf="!isLoadingExtraDetails && !isTracklistArray"
            class="w-full bg-[#09101F] p-6 rounded-lg text-center"
          >
            <p class="text-gray-400">No tracklist available.</p>
          </div>
        </div>
      </div>

      <!-- Album and Song Section  -->
      <div *ngIf="record.type !== 'Artist'">
        <div class="relative flex justify-center items-center">
          <img
            [src]="record.cover || ''"
            class="w-[55%] h-auto rounded-md mt-[2rem] border-2 border-gray-500"
            alt="Record Image"
          />
        </div>
        <div class="px-2">
          <div
            class="p-4 text-white w-full mt-[1rem] px-3 border border-[#142249] rounded-lg"
          >
            <div class="text-xl font-bold leading-snug mb-1">
              {{ record.title }}
            </div>
            <div
              *ngIf="record.type === 'Album'"
              class="text-base text-gray-400 pt-1"
            >
              <div class="text-base text-gray-400 pt-1">
                Artist: <span class="text-white">{{ record.artist }}</span>
              </div>
            </div>
            <div class="text-base text-gray-400 pt-1">
              Released:
              <span class="text-white">{{
                formatDate(record.releaseDate)
              }}</span>
            </div>
            <div
              *ngIf="record.type === 'Song'"
              class="text-base text-gray-400 pt-1"
            >
              Album:
              <span class="text-white">{{ record.album }}</span>
            </div>
            <div class="text-base text-gray-400 pt-1">
              Genre: <span class="text-white">{{ record.genre }}</span>
            </div>

            <!-- (Type: Song) Contributors -->
            <div *ngIf="record.type === 'Song' && record.contributors?.length">
              <div class="text-base text-gray-400 pt-1">
                Contributors:
                <span class="text-white">{{
                  record.contributors.join(", ")
                }}</span>
              </div>
            </div>
          </div>
          <!-- Album Tracklist -->
          <ul
            *ngIf="isTracklistArray && record.type === 'Album'"
            class="space-y-3 w-full mt-3 p-2 pb-3 rounded-lg"
          >
            <li
              *ngFor="let track of record.tracklist; let i = index"
              class="flex items-center justify-between py-4 pr-4 pl-2 bg-[#09101F] rounded-xl transition-all duration-300 border border-[#142249]"
              [ngClass]="{
                'opacity-50': !track.preview || track.preview.length <= 1,
                'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
              }"
            >
              <!-- Play Button -->
              <ng-container *ngIf="track.preview && track.preview.length > 1">
                <div
                  class="flex items-center justify-center w-12 h-12 bg-[#1F273A] text-white rounded-full mr-3 px-3 transition-all duration-300"
                  [ngClass]="{
                    'transition-all duration-700 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                      track.isPlaying
                  }"
                  (click)="playTrack(track)"
                >
                  <i
                    [ngClass]="{
                      fas: true,
                      'fa-pause': track.isPlaying,
                      'fa-play': !track.isPlaying
                    }"
                    class="text-lg transition-all duration-700"
                  >
                  </i>
                </div>
              </ng-container>

              <!-- Title and album info -->
              <div
                class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
              >
                <div class="flex items-center gap-2 min-w-0 text-xl">
                  <span
                    (click)="openSong(track)"
                    class="text-white text-base truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                  >
                    <span
                      class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                      >{{ track.title }}</span
                    >
                  </span>
                </div>
                <div
                  (click)="openSong(track)"
                  class="flex items-center gap-2 text-gray-400 text-sm"
                >
                  <span
                    *ngIf="track.isExplicit"
                    class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                  >
                    E
                  </span>
                  <span
                    class="truncate overflow-hidden whitespace-nowrap block flex-1"
                    [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                  >
                    {{ track.artist }}
                  </span>
                </div>
              </div>

              <!-- Duration -->
              <span
                (click)="openSong(track)"
                class="text-gray-300 bg-[#172438] text-base shrink-0 ml-2.5 p-1 px-1.5 rounded-md"
              >
                {{ formatDuration(track.duration) || "?" }}
              </span>
            </li>
          </ul>

          <!-- Loading state -->
          <div
            *ngIf="isLoadingExtraDetails"
            class="w-full bg-[#09101F] p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
          >
            <p class="text-gray-400 text-center mb-4">Loading...</p>
            <div
              class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
            ></div>
          </div>

          <!-- No tracklist -->
          <div
            *ngIf="
              !isLoadingExtraDetails &&
              !isTracklistArray &&
              record.type === 'Album'
            "
            class="w-full bg-[#09101F] p-6 rounded-lg text-center"
          >
            <p class="text-gray-400">No tracklist available.</p>
          </div>
        </div>
      </div>
    </div>

    <!--iPod Front -->
    <div
      [@slideAnimation]="showSecondIpod ? 'hidden' : 'front'"
      [ngClass]="{ 'invisible-view': showSecondIpod }"
      class="absolute inset-0 flex flex-col w-full h-[100dvh] min-h-0"
      #iPodFront
    >
      <div class="bg-[#09101F] w-full flex flex-col flex-grow min-h-0">
        <div
          class="flex justify-between items-center px-4 w-full min-h-[60px] pt-1 topBar"
        >
          <!-- Info Button -->
          <button
            (click)="showSecondIpod = true"
            class="w-[4rem] h-[3rem] rounded-full bg-white flex items-center justify-center shadow-md"
          >
            <i class="fa-solid fa-info text-[#09101F] text-xl"></i>
          </button>

          <!-- Overall Rating -->
          <div class="flex justify-center w-full my-4">
            <div
              class="relative w-[75%] flex flex-col items-center justify-center"
            >
              <ng-container
                *ngIf="
                  !isRatingLoaded ||
                    isDeleteLoading ||
                    isEditLoading ||
                    isCreateLoading;
                  else ratingAvailable
                "
              >
                <!-- Loading Spinner -->
                <div
                  class="animate-pulse bg-gray-600 rounded w-full h-16 flex items-center justify-center"
                >
                  <i class="fas fa-spinner fa-spin text-gray-400 text-3xl"></i>
                </div>
              </ng-container>

              <ng-template #ratingAvailable>
                <ng-container
                  *ngIf="getAverageRating() > 0; else noReviewsMessage"
                >
                  <!-- Rating Badge -->
                  <div
                    (click)="scrollToReviews()"
                    class="rating-badge-bg px-3 py-1 rounded-full text-white text-3xl font-bold tracking-wide shadow mb-2 flex items-center justify-center"
                  >
                    <ng-container
                      *ngIf="getAverageRating() === 10; else formattedRating"
                    >
                      10
                    </ng-container>
                    <ng-template #formattedRating>
                      {{ getAverageRating() | number : "1.1-1" }}
                    </ng-template>
                    <span class="text-lg font-medium text-gray-300 ml-1"
                      >/ 10</span
                    >
                  </div>

                  <!-- Progress Bar -->
                  <div
                    class="mt-1 w-full bg-gray-700 h-3 rounded-full overflow-hidden"
                  >
                    <div
                      class="h-3 rounded-full transition-all duration-700 ease-out"
                      [style.width.%]="ratingBarFill"
                      [style.background]="getRatingGradient()"
                    ></div>
                  </div>
                </ng-container>
              </ng-template>
            </div>
          </div>

          <!-- No Reviews Star Rating Prompt -->
          <ng-template #noReviewsMessage>
            <div
              class="flex flex-col items-center justify-center text-gray-300"
            >
              <div class="inline-flex space-x-1" (click)="scrollToReviews()">
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
                <i class="far fa-star text-3xl"></i>
              </div>
              <!-- Ensure only the text is clickable -->
              <span
                class="text-lg font-medium cursor-pointer"
                (click)="scrollToReviews()"
                >Be the first to rate!</span
              >
            </div>
          </ng-template>

          <!-- Close Button -->
          <button
            (click)="close()"
            class="w-[4rem] h-[3rem] rounded-full bg-white flex items-center justify-center shadow-md"
          >
            <i class="fas fa-times text-[#09101F] text-xl"></i>
          </button>
        </div>

        <!-- Middle Section: Image + Info/Text -->
        <div
          class="flex-1 min-h-0 flex flex-col items-center justify-center overflow-hidden px-4"
        >
          <div
            class="relative max-w-[85%] w-full flex justify-center items-center"
          >
            <img
              [src]="record.type === 'Artist' ? record.picture : record.cover"
              [alt]="record.type === 'Artist' ? record.name : record.title"
              class="rounded-lg w-full max-w-[420px] max-h-[420px] object-contain imageHeight"
              (load)="isImageLoaded = true"
            />
          </div>

          <!-- Title/Text -->
          <div class="text-center text-3xl mt-4 text-gray-200 font-semibold">
            <ng-container *ngIf="record.type === 'Artist'">
              <span class="text-gray-400 text-xl block uppercase mb-2"
                >Artist</span
              >
            </ng-container>
            <ng-container *ngIf="record.type === 'Album'">
              <span class="text-gray-400 text-xl block uppercase mb-2"
                >Album</span
              >
            </ng-container>
            <div
              class="title-wrapper"
              [class.masked]="isTextOverflowing"
              #scrollingWrapper
            >
              <div
                class="title-content"
                #scrollingContent
                [class.scroll-animate]="isTextOverflowing"
              >
                <span
                  *ngIf="record.type !== 'Artist'"
                  class="inline-block align-middle"
                >
                  {{ record.title }}
                </span>
                <span *ngIf="record.type === 'Artist'">{{ record.name }}</span>
              </div>
            </div>
            <p
              class="text-gray-400 text-xl flex items-center justify-center mt-2"
            >
              <span
                *ngIf="isExplicit"
                class="bg-gray-600 text-white text-base w-[1.5em] h-[1.5em] flex items-center justify-center font-bold rounded leading-none mr-1"
              >
                E
              </span>
              <span
                class="truncate overflow-hidden whitespace-nowrap max-w-full px-2"
              >
                {{ record.type !== "Artist" ? record.artist : "" }}
              </span>
            </p>
          </div>
        </div>
        <app-audio-player
          *ngIf="record"
          [record]="record"
          [hidden]="showSecondIpod"
          [showForwardAndBackwardButtons]="showForwardAndBackwardButtons"
          #audioPlayerMobile
          [song]="currentSong"
          (next)="nextSong()"
          (previous)="prevSong()"
          (playStatus)="updatePlayStatus($event)"
          (playStarted)="onAudioPlayStarted($event)"
          [currentIndex]="currentIndex"
          [recordList]="recordList"
        ></app-audio-player>
      </div>
    </div>
  </div>

  <!-- Add to List Button -->
  <div *ngIf="!showSecondIpod">
    <button
      *ngIf="!isProfileLoading && !isInList"
      class="mt-[2rem] w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-[#0F5EE4] hover:bg-indigo-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
      [disabled]="addingToList"
      (click)="addToList(record)"
    >
      <ng-container *ngIf="!addingToList; else addingState">
        <i class="fas fa-plus-circle mr-2 text-2xl"></i>
        Add to List
      </ng-container>
    </button>

    <!-- Remove from List Button -->
    <button
      *ngIf="!isProfileLoading && isInList"
      class="mt-4 w-auto mx-auto text-white font-bold py-2 mt-4 px-6 rounded-full flex items-center justify-center text-lg bg-red-500 hover:bg-red-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
      [disabled]="addingToList"
      (click)="removeFromList(record)"
    >
      <ng-container *ngIf="!addingToList; else removingState">
        <i class="fas fa-trash text-2xl mr-2"></i> Remove from List
      </ng-container>
    </button>

    <!-- Loading templates -->
    <ng-template #addingState>
      <i class="fas fa-spinner fa-spin mr-2"></i> Adding...
    </ng-template>

    <ng-template #removingState>
      <i class="fas fa-spinner fa-spin mr-2"></i> Removing...
    </ng-template>
  </div>

  <!-- Reviews Section -->
  <div
    #reviewsSection
    *ngIf="!showSecondIpod"
    class="bg-[#171a21] shadow-md w-full mx-auto mt-3"
  >
    <div
      class="sticky top-0 z-30 bg-[#000000] px-3 py-2 rounded-t-sm shadow-[rgba(0,0,0,0.2)_0px_2px_6px]"
    >
      <!-- Center: Reviews Header -->
      <div
        class="flex justify-center mb-4 pt-2 pb-2 border-b border-b-gray-500"
      >
        <h2 class="text-3xl font-semibold text-white">
          Reviews
          <span class="text-base text-gray-400 font-medium">
            {{
              combinedReviews.length > 0
                ? "(" + combinedReviews.length + ")"
                : ""
            }}
          </span>
        </h2>
      </div>

      <div class="relative w-full h-[40px] flex items-center justify-between">
        <!-- Left: Filter Button -->
        <div class="flex items-center">
          <ng-container *ngIf="isFilterActive(); else filterButton">
            <div class="flex items-center gap-2 text-amber-400 font-semibold">
              <i class="fas fa-filter text-lg ml-2"></i>
              <span class="capitalize text-lg"
                >Filtered: {{ activeFilter }}</span
              >
              <button
                (click)="clearFilter()"
                class="text-gray-300 hover:text-white transition"
                aria-label="Clear Filter"
              >
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
          </ng-container>

          <ng-template #filterButton>
            <button
              (click)="toggleFilterMenu()"
              [disabled]="combinedReviews.length <= 1"
              class="flex items-center gap-1 text-lg font-semibold"
              [ngClass]="{
                'text-amber-400': combinedReviews.length > 1,
                'text-white': combinedReviews.length <= 1
              }"
            >
              <i class="fas fa-filter text-lg mr-1 ml-2"></i>
              <span>Filter</span>
            </button>
          </ng-template>
        </div>

        <!-- Right: Add Button -->
        <div *ngIf="!isAddingReview && isReviewsLoaded">
          <button
            (click)="toggleReviewForm()"
            [disabled]="existingUserReview"
            [ngClass]="{
              'bg-[#0F5EE4] text-white': !existingUserReview,
              'bg-gray-500 text-gray-300': existingUserReview
            }"
            class="flex items-center gap-1 px-3 py-1 rounded-md font-medium text-lg"
          >
            <i class="fas fa-plus-circle text-lg mr-1"></i>
            <span class="mr-2">Add</span>
          </button>
        </div>
      </div>
    </div>

    <div>
      <ng-container *ngIf="!isReviewsLoaded; else reviewsContentMobile">
        <div class="space-y-3 mt-3">
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
        </div>
      </ng-container>

      <ng-template #reviewsContentMobile>
        <!-- Fullscreen Overlay for Creating -->
        <div
          *ngIf="isAddingReview"
          @overlayAnimation
          class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
          style="height: 100dvh"
        >
          <div
            class="bg-[#262729] shadow-lg flex flex-col items-center justify-between"
            style="width: 100vw; height: 100dvh"
          >
            <!-- Header with Back Button -->
            <div
              class="relative w-full h-[64px] flex items-center justify-center border-b-2 border-gray-500 px-4"
            >
              <button
                [disabled]="isCreateLoading"
                (click)="cancelReview()"
                class="text-white px-4 py-2 rounded-full flex items-center justify-center absolute left-4"
              >
                <i class="fas fa-circle-arrow-left text-3xl"></i>
              </button>
              <p class="text-white font-semibold text-2xl text-center">
                Write Review
              </p>
            </div>

            <!-- Rating Section -->
            <div
              class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden"
            >
              <div class="text-center w-full mx-auto">
                <!-- Star Rating Display -->
                <div class="flex justify-center mb-4 gap-0.5">
                  <ng-container
                    *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                  >
                    <ng-container [ngSwitch]="getStarType(star, newRating)">
                      <i
                        *ngSwitchCase="'full'"
                        class="fas fa-star text-3xl text-yellow-400 star-size"
                      ></i>
                      <i
                        *ngSwitchCase="'half'"
                        class="fas fa-star-half-alt text-3xl text-yellow-400 star-size"
                      ></i>
                      <i
                        *ngSwitchCase="'empty'"
                        class="far fa-star text-3xl text-gray-500 star-size"
                      ></i>
                    </ng-container>
                  </ng-container>
                </div>

                <p class="text-white font-medium text-2xl mb-2 text-center">
                  Rating:
                  <input
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    [(ngModel)]="newRating"
                    (keypress)="onKeyPressRating($event, 'new')"
                    (blur)="onBlurRating('new')"
                    class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                  />
                  <span
                    class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                    >/ 10</span
                  >
                </p>

                <!-- Slider -->
                <input
                  type="range"
                  min="0"
                  max="10"
                  step="0.1"
                  [(ngModel)]="newRating"
                  [style.background]="getSliderBackground(newRating)"
                  class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                />
              </div>

              <!-- Textarea -->
              <textarea
                [(ngModel)]="newReview"
                [disabled]="isCreateLoading"
                class="w-full flex-grow mt-5 p-3 text-lg bg-[#1E2125] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                placeholder="Leave your feedback..."
                style="min-height: 120px; max-height: calc(100dvh - 300px)"
              ></textarea>

              <!-- Submit Button -->
              <div class="flex font-medium w-full mt-3 pb-3">
                <button
                  [disabled]="isCreateLoading"
                  (click)="submitReview()"
                  class="bg-[#0F5EE4] text-2xl px-4 py-4 rounded-full text-white w-full flex items-center justify-center gap-2"
                >
                  <ng-container *ngIf="!isCreateLoading">
                    <i class="fas fa-paper-plane"></i> Create
                  </ng-container>
                  <ng-container *ngIf="isCreateLoading">
                    <i class="fas fa-spinner fa-spin"></i> Creating
                  </ng-container>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- All Reviews Section -->
        <div>
          <ng-container
            *ngIf="
              existingUserReview || filteredReviews.length > 0;
              else noReviewsMobile
            "
          >
            <ul class="space-y-4 mt-1 bg-[#171a21] px-2" @fadeIn>
              <li
                *ngFor="
                  let review of pagedReviews;
                  let i = index;
                  trackBy: trackById
                "
                class="review-card p-2 flex flex-col gap-2 relative bg-[#171a21]"
                [ngClass]="{
                  'border-b border-gray-500': i < pagedReviews.length - 1
                }"
              >
                <!-- Fullscreen Overlay for Editing -->
                <div
                  *ngIf="isEditingReview"
                  @overlayAnimation
                  class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
                  style="height: 100dvh"
                >
                  <div
                    class="bg-[#262729] shadow-lg flex flex-col items-center justify-between"
                    style="width: 100vw; height: 100dvh"
                  >
                    <!-- Header with Back Button -->
                    <div
                      class="relative w-full h-[64px] flex items-center justify-center border-b-2 border-gray-500 px-4"
                    >
                      <button
                        [disabled]="isEditLoading"
                        (click)="cancelEditReview()"
                        class="text-white px-4 py-2 rounded-full flex items-center justify-center absolute left-4"
                      >
                        <i class="fas fa-circle-arrow-left text-3xl"></i>
                      </button>
                      <p class="text-white font-semibold text-2xl text-center">
                        Editing Review
                      </p>
                    </div>

                    <!-- Edit Rating Section -->
                    <div
                      class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden"
                    >
                      <div class="text-center w-full mx-auto">
                        <!-- Star Rating Display -->
                        <div class="flex justify-center mb-4 gap-0.5">
                          <ng-container
                            *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                          >
                            <ng-container
                              [ngSwitch]="getStarType(star, editedRating)"
                            >
                              <i
                                *ngSwitchCase="'full'"
                                class="fas fa-star text-3xl text-yellow-400 star-size"
                              ></i>
                              <i
                                *ngSwitchCase="'half'"
                                class="fas fa-star-half-alt text-3xl text-yellow-400 star-size"
                              ></i>
                              <i
                                *ngSwitchCase="'empty'"
                                class="far fa-star text-3xl text-gray-500 star-size"
                              ></i>
                            </ng-container>
                          </ng-container>
                        </div>

                        <p
                          class="text-white font-medium text-2xl mb-2 text-center"
                        >
                          Rating:
                          <input
                            type="number"
                            min="0"
                            max="10"
                            step="0.1"
                            [(ngModel)]="editedRating"
                            (keypress)="onKeyPressRating($event, 'edit')"
                            (blur)="onBlurRating('edit')"
                            class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                          />
                          <span
                            class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                            >/ 10</span
                          >
                        </p>

                        <!-- Slider Control -->
                        <input
                          type="range"
                          min="0"
                          max="10"
                          step="0.1"
                          [(ngModel)]="editedRating"
                          [style.background]="getSliderBackground(editedRating)"
                          class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                        />
                      </div>

                      <!-- Review Text -->
                      <textarea
                        [(ngModel)]="editedReviewText"
                        [disabled]="isEditLoading"
                        class="w-full flex-grow mt-5 p-3 text-lg bg-[#1E2125] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                        placeholder="Leave your feedback..."
                        style="
                          min-height: 120px;
                          max-height: calc(100dvh - 300px);
                        "
                      ></textarea>

                      <!-- Button -->
                      <div class="flex font-medium w-full px-4 py-4">
                        <button
                          [disabled]="isEditLoading"
                          (click)="submitEditReview()"
                          class="bg-[#0F5EE4] text-2xl px-4 py-4 rounded-full text-white w-full flex items-center justify-center gap-2"
                        >
                          <ng-container *ngIf="!isEditLoading">
                            <i class="fas fa-save mr-1"></i> Save
                          </ng-container>
                          <ng-container *ngIf="isEditLoading">
                            <i class="fas fa-spinner fa-spin mr-1"></i> Saving
                          </ng-container>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-container
                  *ngIf="
                    !(
                      existingUserReview &&
                      review._id === existingUserReview._id &&
                      isDeleteLoading
                    );
                    else deletingReviewLoaderMobile
                  "
                >
                  <!-- Edit/Delete Buttons for User's Review -->
                  <ng-container
                    *ngIf="
                      existingUserReview &&
                      review._id === existingUserReview._id &&
                      !isEditingReview
                    "
                  >
                    <button
                      (click)="toggleEditReview(review)"
                      class="absolute bottom-3.5 right-[1rem] text-gray-400 transition"
                    >
                      <i class="fas fa-edit text-2xl"></i>
                    </button>
                    <button
                      (click)="showdeleteConfirmation(review)"
                      class="absolute bottom-3.5 left-[1rem] text-gray-400 transition"
                    >
                      <i class="fas fa-trash text-[1.3rem]"></i>
                    </button>
                  </ng-container>

                  <div class="flex items-start mt-[1rem]">
                    <!-- Profile Picture -->
                    <img
                      [src]="review.user.profilePicture || 'assets/user.png'"
                      alt="Profile Picture"
                      class="w-[4rem] h-[4rem] rounded-full object-cover"
                      (click)="goToProfile(review.user._id)"
                    />

                    <!-- Username and Review Info -->
                    <div class="ml-3 flex-1">
                      <p class="text-white text-lg font-semibold pr-[.8rem]">
                        {{
                          existingUserReview &&
                          review._id === existingUserReview._id
                            ? "Your Review"
                            : review.user.username
                        }}
                      </p>
                      <p class="text-gray-400 text-sm">
                        {{ review.createdAt | date : "short" }}
                      </p>
                    </div>

                    <!-- Rating Badge -->
                    <p
                      class="rating-badge text-white text-lg rounded-md px-3 py-1.5 text-center"
                      style="width: 6.95rem"
                    >
                      <i class="fas fa-star text-yellow-400"></i>
                      {{ review.rating }} / 10
                    </p>
                  </div>

                  <!-- Review Text -->
                  <div
                    class="mt-3 px-1"
                    [ngClass]="{
                      'pb-[4rem]':
                        existingUserReview &&
                        review._id === existingUserReview._id
                    }"
                  >
                    <p class="text-white text-lg break-words">
                      {{ review.reviewText }}
                    </p>
                  </div>
                </ng-container>

                <ng-template #deletingReviewLoaderMobile>
                  <div
                    class="flex items-center justify-center h-16 bg-gray-800 rounded-lg p-4"
                  >
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <span class="ml-2 text-gray-300 text-lg">Deleting...</span>
                  </div>
                </ng-template>
              </li>
            </ul>
            <div
              class="mt-4 mb-3 px-4 py-3 bg-[#1e1f22] border-t border-gray-700 rounded-b-md text-base text-white flex flex-col items-center"
              *ngIf="totalPages > 1"
            >
              <span class="mb-2 font-medium text-base text-gray-400">Page</span>
              <div class="flex gap-2">
                <button
                  *ngFor="let p of [].constructor(totalPages); let i = index"
                  (click)="changePage(i + 1)"
                  [ngClass]="{
                    'bg-indigo-600': page === i + 1,
                    'bg-gray-600': page !== i + 1
                  }"
                  class="px-3 py-1 rounded text-sm font-medium text-white transition"
                >
                  {{ i + 1 }}
                </button>
              </div>
            </div>
          </ng-container>

          <ng-template #noReviewsMobile>
            <p class="text-gray-400 mt-8 pb-5 text-center text-xl">
              No reviews yet.
            </p>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<div
  *ngIf="filterMenuOpen"
  class="fixed inset-0 z-[9999] bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center px-4"
  (click)="clearFilter()"
>
  <div
    class="relative bg-[#1e1f22] rounded-2xl shadow-xl px-6 py-7 w-full max-w-sm flex flex-col items-center gap-5"
    (click)="$event.stopPropagation()"
  >
    <!-- Close Button -->
    <button
      (click)="clearFilter()"
      class="absolute top-4 left-4 text-gray-400 hover:text-white text-2xl transition"
    >
      <i class="fas fa-times"></i>
    </button>

    <h3 class="text-white text-2xl mt-3 font-semibold tracking-wide">
      Filter Reviews
    </h3>

    <button
      (click)="applyFilter('newest')"
      class="w-full bg-[#0F5EE4] hover:bg-[#0D51CC] active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-clock"></i> Newest First
    </button>

    <button
      (click)="applyFilter('highest')"
      class="w-full bg-green-500 hover:bg-green-600 active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-star"></i> Highest Rated
    </button>

    <button
      (click)="applyFilter('lowest')"
      class="w-full bg-red-500 hover:bg-red-600 active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-arrow-down"></i> Lowest Rated
    </button>
  </div>
</div>

<!-- SEPARATION OF THE MODALS -->

<!-- DESKTOP/TABLET MODAL -->
<div
  @slideUp
  *ngIf="isModalOpen"
  class="hidden md:flex min-h-[90vh] fixed inset-0 items-center justify-center bg-black bg-opacity-50 overflow-y-auto custom-scrollbar z-50"
>
  <div
    class="relative bg-[#1E1E1E] text-white md:w-[90%] xl:w-[85%] 2xl:w-[75%] sm:rounded-xl shadow-lg p-3 flex flex-col min-h-[90vh] max-h-[90vh]"
  >
    <!-- Exit Button -->
    <button
      (click)="close()"
      class="absolute top-3 right-3 bg-gray-800 hover:bg-gray-700 text-white w-[4rem] h-[4rem] rounded-full flex items-center justify-center transition border-2 border-white shadow-lg"
    >
      <i class="fas fa-times text-xl"></i>
    </button>

    <!-- Overall Rating Circle -->
    <div class="flex justify-center w-full">
      <ng-container
        *ngIf="
          !isRatingLoaded ||
            isCreateLoading ||
            isEditLoading ||
            isDeleteLoading;
          else ratingContentDesktop
        "
      >
        <!-- Loading State (Spinner) -->
        <div
          class="animate-pulse bg-gray-600 rounded-full w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <i
            class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
          ></i>
        </div>
      </ng-container>

      <ng-template #ratingContentDesktop>
        <div
          class="relative w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <svg
            width="100%"
            height="100%"
            viewBox="0 0 42 42"
            class="circular-chart absolute w-full h-full"
          >
            <defs>
              <linearGradient
                id="ratingGradientDesktop"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop
                  offset="0%"
                  style="stop-color: #facc15; stop-opacity: 1"
                />
                <stop
                  offset="100%"
                  style="stop-color: #f59e0b; stop-opacity: 1"
                />
              </linearGradient>
            </defs>

            <!-- Background Circle -->
            <circle
              class="circle-bg"
              cx="21"
              cy="21"
              r="18"
              stroke-width="4"
              [attr.style]="
                isRatingLoaded &&
                !isDeleteLoading &&
                !isEditLoading &&
                !isCreateLoading &&
                getAverageRating() === 0
                  ? 'stroke-opacity: 0;'
                  : ''
              "
            />

            <!-- Foreground Circle (Rating Progress) -->
            <circle
              class="circle"
              cx="21"
              cy="21"
              r="18"
              stroke="url(#ratingGradientDesktop)"
              stroke-width="4"
              stroke-dasharray="113.1"
              [attr.stroke-dashoffset]="circleDashOffset"
              [attr.style]="
                getAverageRating() === 0 ? 'stroke-opacity: 0;' : ''
              "
              stroke-linecap="butt"
            />
          </svg>

          <!-- Rating Display OR No Reviews Message -->
          <span
            class="absolute inset-0 flex flex-col items-center justify-center text-white font-bold text-2xl md:text-3xl lg:text-4xl"
          >
            <ng-container
              *ngIf="
                isRatingLoaded &&
                  !isDeleteLoading &&
                  !isEditLoading &&
                  !isCreateLoading;
                else loadingSpinner
              "
            >
              <ng-container
                *ngIf="getAverageRating() > 0; else noReviewsMessage"
              >
                <ng-container
                  *ngIf="getAverageRating() === 10; else formattedRating"
                >
                  10
                </ng-container>
                <ng-template #formattedRating>
                  {{ getAverageRating() | number : "1.1-1" }}
                </ng-template>
                <span class="text-xs md:text-sm font-medium text-gray-300"
                  >/ 10</span
                >
              </ng-container>
            </ng-container>
          </span>
        </div>
      </ng-template>
    </div>

    <!-- No Reviews: Show Star Rating Prompt -->
    <ng-template #noReviewsMessage>
      <div class="flex flex-col items-center justify-center text-gray-400">
        <div class="flex space-x-1">
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
        </div>
        <span class="text-lg font-medium">Be the first to rate!</span>
      </div>
    </ng-template>

    <!-- Small Loader Inside Circle -->
    <ng-template #loadingSpinner>
      <div class="animate-pulse flex items-center justify-center">
        <i
          class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
        ></i>
      </div>
    </ng-template>

    <div class="flex-1 flex flex-col pr-2">
      <!-- Two-Column Layout -->
      <div class="flex flex-col md:flex-row items-start gap-4 mt-2">
        <!-- Wrapper for both iPods -->
        <div
          class="relative w-[50vw] max-w-[330px] h-[70vh] overflow-auto overflow-hidden"
        >
          <!-- First iPod -->
          <div
            class="relative transition-transform duration-500"
            [@iPodTransition]="iPodState"
            *ngIf="!showSecondIpod"
          >
            <div
              class="bg-[#09101F] rounded-lg p-3 md:p-4 w-full overflow-hidden"
            >
              <div class="flex flex-col h-full">
                <!-- Image Area -->
                <div
                  class="relative flex-1 flex items-center justify-center w-full min-h-[200px] max-h-[60vh]"
                >
                  <!-- Image Wrapper (Matches Mobile Structure) -->
                  <div
                    class="relative w-full aspect-square flex items-center justify-center overflow-hidden rounded-lg"
                  >
                    <!-- Skeleton Loader -->
                    <div
                      *ngIf="!isImageLoaded"
                      class="absolute inset-0 flex items-center justify-center bg-gray-700 skeleton-wave rounded-lg"
                    ></div>

                    <!-- Actual Image (Fixed) -->
                    <img
                      *ngIf="isImageLoaded"
                      [src]="
                        record.type === 'Artist' ? record.picture : record.cover
                      "
                      [alt]="
                        record.type === 'Artist' ? record.name : record.title
                      "
                      (click)="showSecondIpod = true"
                      class="w-full h-full object-contain rounded-lg cursor-pointer transition-transform duration-300 ease-in-out hover:opacity-80"
                    />
                  </div>
                </div>

                <!-- Info and Audio Player -->
                <div
                  class="flex flex-col items-center justify-center flex-1 pb-4 pt-2 w-full"
                >
                  <div
                    class="text-center text-2xl mb-4 text-gray-200 font-semibold w-full"
                  >
                    <ng-container *ngIf="record.type === 'Artist'">
                      <span class="text-gray-400 text-xl block uppercase mt-2">
                        Artist
                      </span>
                    </ng-container>
                    <div
                      class="title-wrapper"
                      [class.masked]="isTextOverflowing"
                      #scrollingWrapperDesktop
                    >
                      <div
                        class="title-content"
                        #scrollingContentDesktop
                        [class.scroll-animate]="isTextOverflowing"
                      >
                        <span
                          *ngIf="record.type !== 'Artist'"
                          class="inline-block align-middle mt-3"
                        >
                          {{ record.title }}
                        </span>
                        <span *ngIf="record.type === 'Artist'">
                          {{ record.name }}
                        </span>
                      </div>
                    </div>
                    <p
                      class="text-gray-400 flex items-center justify-center mt-2"
                    >
                      <span
                        *ngIf="isExplicit"
                        class="bg-gray-600 text-white text-base w-[1.5em] h-[1.5em] flex items-center justify-center font-bold rounded leading-none mr-1"
                      >
                        E
                      </span>
                      <span
                        class="truncate overflow-hidden text-base whitespace-nowrap max-w-full px-2"
                      >
                        {{ record.type !== "Artist" ? record.artist : "" }}
                      </span>
                    </p>
                  </div>
                  <div
                    class="h-auto flex items-end justify-center pb-[env(safe-area-inset-bottom)]"
                  >
                    <app-audio-player
                      class="pt-1"
                      *ngIf="record"
                      [record]="record"
                      [hidden]="showSecondIpod"
                      [showForwardAndBackwardButtons]="
                        showForwardAndBackwardButtons
                      "
                      #audioPlayerDesktop
                      (next)="nextSong()"
                      [song]="currentSong"
                      (previous)="prevSong()"
                      (playStatus)="updatePlayStatus($event)"
                      (playStarted)="onAudioPlayStarted($event)"
                      [currentIndex]="currentIndex"
                      [recordList]="recordList"
                    ></app-audio-player>
                  </div>
                  <!-- Add to List Button -->
                  <button
                    *ngIf="!isProfileLoading && !isInList"
                    class="mt-4 w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-[#0F5EE4] hover:bg-indigo-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
                    [disabled]="addingToList"
                    (click)="addToList(record)"
                  >
                    <ng-container *ngIf="!addingToList; else addingState">
                      <i class="fas fa-plus-circle mr-2 text-2xl"></i>
                      Add to List
                    </ng-container>
                  </button>

                  <!-- Remove from List Button -->
                  <button
                    *ngIf="!isProfileLoading && isInList"
                    class="mt-4 w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-red-500 hover:bg-red-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
                    [disabled]="addingToList"
                    (click)="removeFromList(record)"
                  >
                    <ng-container *ngIf="!addingToList; else removingState">
                      <i class="fas fa-trash text-2xl mr-2"></i> Remove from
                      List
                    </ng-container>
                  </button>

                  <!-- Loading templates -->
                  <ng-template #addingState>
                    <i class="fas fa-spinner fa-spin mr-2"></i> Adding...
                  </ng-template>

                  <ng-template #removingState>
                    <i class="fas fa-spinner fa-spin mr-2"></i> Removing...
                  </ng-template>
                </div>
              </div>
            </div>
          </div>

          <!-- Back of iPod (Desktop) -->
          <div
          [@slideAnimation]="showSecondIpod ? 'back' : 'hidden'"
          [ngClass]="{ 'invisible-view': !showSecondIpod }"
          *ngIf="showSecondIpod"
          class="absolute inset-0 z-30 overflow-y-auto custom-scrollbar pr-2"
        >
            <!-- Back Button (top-left) -->
            <button
              (click)="onBackClick()"
              class="absolute top-4 left-4 w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-md z-50"
            >
              <i class="fas fa-chevron-left text-[#09101F] text-lg"></i>
            </button>

            <!-- Artist Section -->
            <div *ngIf="record.type === 'Artist'">
              <!-- Image background layer -->
              <div class="relative w-full">
                <img
                  [src]="record.type === 'Artist' ? record.picture : ''"
                  class="w-full h-auto rounded-lg"
                  alt="Record Image"
                />
                <div class="absolute inset-0 bg-black/40 rounded-lg"></div>
              </div>
              <div class="relative left-0 right-0 py-2 z-50">
                <div class="bg-white/30 rounded-md p-3 w-full text-left">
                  <p
                    *ngIf="record.type === 'Artist'"
                    class="text-xl font-semibold"
                  >
                    Top Tracks
                  </p>
                </div>
                <!-- Album Tracklist -->
                <ul
                  *ngIf="isTracklistArray"
                  class="space-y-3 w-full mt-3 rounded-lg"
                >
                  <li
                    *ngFor="let track of record.tracklist; let i = index"
                    class="flex items-center justify-between py-4 pr-4 pl-2 bg-[#09101F] rounded-xl transition-all duration-300 border border-[#142249]"
                    [ngClass]="{
                      'opacity-50': !track.preview || track.preview.length <= 1,
                      'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
                    }"
                  >
                    <!-- Play Button -->
                    <ng-container
                      *ngIf="track.preview && track.preview.length > 1"
                    >
                      <div
                        class="flex items-center justify-center w-12 h-12 bg-[#1F273A] text-white rounded-full mr-3 px-3 transition-all duration-300"
                        [ngClass]="{
                          'transition-all duration-300 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                            track.isPlaying
                        }"
                        (click)="playTrack(track)"
                      >
                        <i
                          [ngClass]="{
                            fas: true,
                            'fa-pause': track.isPlaying,
                            'fa-play': !track.isPlaying
                          }"
                          class="text-lg transition-all duration-300"
                        >
                        </i>
                      </div>
                    </ng-container>

                    <!-- Title and album info -->
                    <div
                      class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
                    >
                      <div class="flex items-center gap-2 min-w-0 text-xl">
                        <span
                          (click)="openSong(track)"
                          class="text-white text-base truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                        >
                          <span
                            *ngIf="track.isExplicit"
                            class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                          >
                            E
                          </span>
                          <span
                            class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                            >{{ track.title }}</span
                          >
                        </span>
                      </div>
                      <div
                        (click)="openSong(track)"
                        class="flex items-center gap-2 text-gray-400 text-sm"
                      >
                        <span
                          class="truncate overflow-hidden whitespace-nowrap block flex-1"
                          [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                        >
                          Album: <span class="pl-2">{{ track.album }}</span>
                        </span>
                      </div>
                    </div>

                    <!-- Duration -->
                    <span
                      (click)="openSong(track)"
                      class="text-gray-300 bg-[#172438] text-base shrink-0 ml-2.5 p-1 px-1.5 rounded-md"
                    >
                      {{ formatDuration(track.duration) || "?" }}
                    </span>
                  </li>
                </ul>

                <!-- Loading state -->
                <div
                  *ngIf="isLoadingExtraDetails"
                  class="w-full bg-[#09101F] p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
                >
                  <p class="text-gray-400 text-center mb-4">
                    Loading tracklist...
                  </p>
                  <div
                    class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
                  ></div>
                </div>

                <!-- No tracklist -->
                <div
                  *ngIf="!isLoadingExtraDetails && !isTracklistArray"
                  class="w-full bg-[#09101F] p-6 rounded-lg text-center"
                >
                  <p class="text-gray-400">No tracklist available.</p>
                </div>
              </div>
            </div>

            <!-- Album and Song Section  -->
            <div *ngIf="record.type !== 'Artist'" class="bg-[#09101F] rounded-lg pb-4 w-full overflow-hidden">
              <div class="relative flex justify-center items-center">
                <img
                  [src]="record.cover || ''"
                  class="w-[55%] h-auto rounded-md mt-[2rem] border-2 border-gray-500"
                  alt="Record Image"
                />
              </div>
              <div class="px-2">
                <div
                  class="p-4 text-white w-full mt-[1rem] px-3 border border-[#142249] rounded-lg"
                >
                  <div class="text-xl font-bold leading-snug mb-1">
                    {{ record.title }}
                  </div>
                  <div
                    *ngIf="record.type === 'Album'"
                    class="text-base text-gray-400 pt-1"
                  >
                    <div class="text-base text-gray-400 pt-1">
                      Artist:
                      <span class="text-white">{{ record.artist }}</span>
                    </div>
                  </div>
                  <div class="text-base text-gray-400 pt-1">
                    Released:
                    <span class="text-white">{{
                      formatDate(record.releaseDate)
                    }}</span>
                  </div>
                  <div
                    *ngIf="record.type === 'Song'"
                    class="text-base text-gray-400 pt-1"
                  >
                    Album:
                    <span class="text-white">{{ record.album }}</span>
                  </div>
                  <div class="text-base text-gray-400 pt-1">
                    Genre: <span class="text-white">{{ record.genre }}</span>
                  </div>

                  <!-- (Type: Song) Contributors -->
                  <div
                    *ngIf="
                      record.type === 'Song' && record.contributors?.length
                    "
                  >
                    <div class="text-base text-gray-400 pt-1">
                      Contributors:
                      <span class="text-white">{{
                        record.contributors.join(", ")
                      }}</span>
                    </div>
                  </div>
                </div>
                <!-- Album Tracklist -->
                <ul
                  *ngIf="isTracklistArray && record.type === 'Album'"
                  class="space-y-3 w-full mt-3 pb-3 rounded-lg"
                >
                  <li
                    *ngFor="let track of record.tracklist; let i = index"
                    class="flex items-center justify-between py-4 pr-4 pl-2 bg-[#09101F] rounded-xl transition-all duration-300 border border-[#142249]"
                    [ngClass]="{
                      'opacity-50': !track.preview || track.preview.length <= 1,
                      'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
                    }"
                  >
                    <!-- Play Button -->
                    <ng-container
                      *ngIf="track.preview && track.preview.length > 1"
                    >
                      <div
                        class="flex items-center justify-center w-12 h-12 bg-[#1F273A] text-white rounded-full mr-3 px-3 transition-all duration-300"
                        [ngClass]="{
                          'transition-all duration-700 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                            track.isPlaying
                        }"
                        (click)="playTrack(track)"
                      >
                        <i
                          [ngClass]="{
                            fas: true,
                            'fa-pause': track.isPlaying,
                            'fa-play': !track.isPlaying
                          }"
                          class="text-lg transition-all duration-700"
                        >
                        </i>
                      </div>
                    </ng-container>

                    <!-- Title and album info -->
                    <div
                      class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
                    >
                      <div class="flex items-center gap-2 min-w-0 text-xl">
                        <span
                          (click)="openSong(track)"
                          class="text-white text-base truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                        >
                          <span
                            class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                            >{{ track.title }}</span
                          >
                        </span>
                      </div>
                      <div
                        (click)="openSong(track)"
                        class="flex items-center gap-2 text-gray-400 text-sm"
                      >
                        <span
                          *ngIf="track.isExplicit"
                          class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                        >
                          E
                        </span>
                        <span
                          class="truncate overflow-hidden whitespace-nowrap block flex-1"
                          [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                        >
                          {{ track.artist }}
                        </span>
                      </div>
                    </div>

                    <!-- Duration -->
                    <span
                      (click)="openSong(track)"
                      class="text-gray-300 bg-[#172438] text-base shrink-0 ml-2.5 p-1 px-1.5 rounded-md"
                    >
                      {{ formatDuration(track.duration) || "?" }}
                    </span>
                  </li>
                </ul>

                <!-- Loading state -->
                <div
                  *ngIf="isLoadingExtraDetails"
                  class="w-full bg-[#09101F] p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
                >
                  <p class="text-gray-400 text-center mb-4">Loading...</p>
                  <div
                    class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
                  ></div>
                </div>

                <!-- No tracklist -->
                <div
                  *ngIf="
                    !isLoadingExtraDetails &&
                    !isTracklistArray &&
                    record.type === 'Album'
                  "
                  class="w-full bg-[#09101F] p-6 rounded-lg text-center"
                >
                  <p class="text-gray-400">No tracklist available.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Reviews section -->
        <div class="bg-[#262729] shadow-md w-full mx-auto rounded-t-lg">
          <div
            class="sticky top-0 z-30 bg-[#000000] px-3 py-2 shadow-[rgba(0,0,0,0.2)_0px_2px_6px] rounded-t-lg"
          >
            <div class="relative w-full flex flex-col items-center">
              <!-- Center: Reviews Header -->
              <div
                class="flex justify-center mb-2 pb-2 border-b border-b-gray-500 w-full"
              >
                <h2 class="text-2xl font-semibold text-white">
                  Reviews
                  <span class="text-base text-gray-400 font-medium">
                    {{
                      combinedReviews.length > 0
                        ? "(" + combinedReviews.length + ")"
                        : ""
                    }}
                  </span>
                </h2>
              </div>

              <div class="w-full flex items-center justify-between pt-2">
                <!-- Left: Filter Button -->
                <div class="flex items-center">
                  <ng-container *ngIf="isFilterActive(); else filterButton">
                    <div
                      class="flex items-center gap-2 text-amber-400 font-semibold"
                    >
                      <i class="fas fa-filter text-lg ml-2"></i>
                      <span class="capitalize text-lg"
                        >Filtered: {{ activeFilter }}</span
                      >
                      <button
                        (click)="clearFilter()"
                        class="text-gray-300 hover:text-white transition"
                        aria-label="Clear Filter"
                      >
                        <i class="fas fa-times-circle"></i>
                      </button>
                    </div>
                  </ng-container>

                  <ng-template #filterButton>
                    <button
                      (click)="toggleFilterMenu()"
                      [disabled]="combinedReviews.length <= 1"
                      class="flex items-center gap-1 text-lg font-semibold"
                      [ngClass]="{
                        'text-amber-400': combinedReviews.length > 1,
                        'text-white': combinedReviews.length <= 1
                      }"
                    >
                      <i class="fas fa-filter text-lg mr-1 ml-2"></i>
                      <span>Filter</span>
                    </button>
                  </ng-template>
                </div>

                <!-- Right: Add Button -->
                <div *ngIf="!isAddingReview && isReviewsLoaded">
                  <button
                    [disabled]="existingUserReview"
                    (click)="toggleReviewForm()"
                    [ngClass]="{
                      'bg-[#0F5EE4] text-white': !existingUserReview,
                      'bg-gray-500 text-gray-300': existingUserReview
                    }"
                    class="flex items-center gap-1 px-3 py-1 rounded-md font-medium"
                  >
                    <i class="fas fa-plus-circle text-lg mr-1"></i>
                    <span>Add</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div>
            <ng-container *ngIf="!isReviewsLoaded; else reviewsContentMobile">
              <div class="space-y-3 mt-3">
                <div
                  class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"
                ></div>
                <div
                  class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"
                ></div>
                <div
                  class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"
                ></div>
              </div>
            </ng-container>

            <ng-template #reviewsContentMobile>
              <!-- Fullscreen Overlay for Creating -->
              <div
                *ngIf="isAddingReview"
                @overlayAnimation
                class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
                style="height: 100dvh"
              >
                <div
                  class="bg-[#262729] shadow-lg flex flex-col items-center justify-between"
                  style="width: 100vw; height: 100dvh"
                >
                  <!-- Header with Back Button -->
                  <div
                    class="relative w-full h-[64px] flex items-center justify-center border-b-2 border-gray-500 px-4"
                  >
                    <button
                      [disabled]="isCreateLoading"
                      (click)="cancelReview()"
                      class="text-white px-4 py-2 rounded-full flex items-center justify-center absolute left-4"
                    >
                      <i class="fas fa-circle-arrow-left text-3xl"></i>
                    </button>
                    <p class="text-white font-semibold text-2xl text-center">
                      Write Review
                    </p>
                  </div>

                  <!-- Rating Section -->
                  <div
                    class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden items-center"
                  >
                    <div class="w-full max-w-[640px] text-center mx-auto">
                      <!-- Star Rating Display -->
                      <div class="flex justify-center mb-4 gap-0.5">
                        <ng-container
                          *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                        >
                          <ng-container
                            [ngSwitch]="getStarType(star, newRating)"
                          >
                            <i
                              *ngSwitchCase="'full'"
                              class="fas fa-star text-3xl text-yellow-400"
                            ></i>
                            <i
                              *ngSwitchCase="'half'"
                              class="fas fa-star-half-alt text-3xl text-yellow-400"
                            ></i>
                            <i
                              *ngSwitchCase="'empty'"
                              class="far fa-star text-3xl text-gray-500"
                            ></i>
                          </ng-container>
                        </ng-container>
                      </div>

                      <p
                        class="text-white font-medium text-2xl mb-2 text-center"
                      >
                        Rating:
                        <input
                          type="number"
                          min="0"
                          max="10"
                          step="0.1"
                          [(ngModel)]="newRating"
                          (keypress)="onKeyPressRating($event, 'new')"
                          (blur)="onBlurRating('new')"
                          class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                        />
                        <span
                          class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                          >/ 10</span
                        >
                      </p>

                      <!-- Slider -->
                      <input
                        type="range"
                        min="0"
                        max="10"
                        step="0.1"
                        [(ngModel)]="newRating"
                        [style.background]="getSliderBackground(newRating)"
                        class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                      />
                    </div>

                    <!-- Textarea -->
                    <div class="w-full max-w-[800px] pt-3 flex-grow">
                      <textarea
                        [(ngModel)]="newReview"
                        [disabled]="isCreateLoading"
                        class="w-full h-full p-3 text-lg bg-[#1E2125] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                        placeholder="Leave your feedback..."
                        style="
                          min-height: 120px;
                          max-height: calc(100dvh - 300px);
                        "
                      ></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div
                      class="flex font-medium w-full mt-3 pb-3 max-w-[640px]"
                    >
                      <button
                        [disabled]="isCreateLoading"
                        (click)="submitReview()"
                        class="bg-[#0F5EE4] text-2xl px-4 py-4 rounded-full text-white w-full flex items-center justify-center gap-2"
                      >
                        <ng-container *ngIf="!isCreateLoading">
                          <i class="fas fa-paper-plane"></i> Create
                        </ng-container>
                        <ng-container *ngIf="isCreateLoading">
                          <i class="fas fa-spinner fa-spin"></i> Creating
                        </ng-container>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- All Reviews Section -->
              <div class="max-h-[65vh] overflow-y-auto custom-scrollbar">
                <ng-container
                  *ngIf="
                    existingUserReview || filteredReviews.length > 0;
                    else noReviewsDesktop
                  "
                >
                  <div
                    class="bg-[#262729] rounded-lg overflow-hidden flex flex-col h-full"
                  >
                    <ul
                      #reviewsSectionDesktop
                      class="space-y-4 p-4 pt-0 overflow-y-auto custom-scrollbar flex-1 max-h-[50vh]"
                      @fadeIn
                    >
                      <li
                        *ngFor="
                          let review of pagedReviews;
                          let i = index;
                          trackBy: trackById
                        "
                        class="review-card p-2 flex flex-col gap-2 relative bg-[#262729]"
                        [ngClass]="{
                          'border-b border-gray-500':
                            i < pagedReviews.length - 1
                        }"
                      >
                        <!-- Fullscreen Overlay for Editing -->
                        <div
                          *ngIf="isEditingReview"
                          @overlayAnimation
                          class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
                          style="height: 100dvh"
                        >
                          <div
                            class="bg-[#262729] shadow-lg flex flex-col items-center justify-between"
                            style="width: 100vw; height: 100dvh"
                          >
                            <!-- Header with Back Button -->
                            <div
                              class="relative w-full h-[64px] flex items-center justify-center border-b-2 border-gray-500 px-4"
                            >
                              <button
                                [disabled]="isEditLoading"
                                (click)="cancelEditReview()"
                                class="text-white px-4 py-2 rounded-full flex items-center justify-center absolute left-4"
                              >
                                <i
                                  class="fas fa-circle-arrow-left text-3xl"
                                ></i>
                              </button>
                              <p
                                class="text-white font-semibold text-2xl text-center"
                              >
                                Editing Review
                              </p>
                            </div>

                            <!-- Edit Rating Section -->
                            <div
                              class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden items-center"
                            >
                              <div
                                class="w-full max-w-[640px] text-center mx-auto"
                              >
                                <!-- Star Rating Display -->
                                <div class="flex justify-center mb-4 gap-0.5">
                                  <ng-container
                                    *ngFor="
                                      let star of [
                                        1, 2, 3, 4, 5, 6, 7, 8, 9, 10
                                      ]
                                    "
                                  >
                                    <ng-container
                                      [ngSwitch]="
                                        getStarType(star, editedRating)
                                      "
                                    >
                                      <i
                                        *ngSwitchCase="'full'"
                                        class="fas fa-star text-3xl text-yellow-400"
                                      ></i>
                                      <i
                                        *ngSwitchCase="'half'"
                                        class="fas fa-star-half-alt text-3xl text-yellow-400"
                                      ></i>
                                      <i
                                        *ngSwitchCase="'empty'"
                                        class="far fa-star text-3xl text-gray-500"
                                      ></i>
                                    </ng-container>
                                  </ng-container>
                                </div>

                                <p
                                  class="text-white font-medium text-2xl mb-2 text-center"
                                >
                                  Rating:
                                  <input
                                    type="number"
                                    min="0"
                                    max="10"
                                    step="0.1"
                                    [(ngModel)]="editedRating"
                                    (keypress)="
                                      onKeyPressRating($event, 'edit')
                                    "
                                    (blur)="onBlurRating('edit')"
                                    class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-transparent border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                                  />
                                  <span
                                    class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                                    >/ 10</span
                                  >
                                </p>

                                <!-- Slider Control -->
                                <input
                                  type="range"
                                  min="0"
                                  max="10"
                                  step="0.1"
                                  [(ngModel)]="editedRating"
                                  [style.background]="
                                    getSliderBackground(editedRating)
                                  "
                                  class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern"
                                />
                              </div>

                              <!-- Review Text -->
                              <div class="w-full pt-3 max-w-[800px] flex-grow">
                                <textarea
                                  [(ngModel)]="editedReviewText"
                                  [disabled]="isEditLoading"
                                  class="w-full h-full p-3 text-xl bg-[#1E2125] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                                  placeholder="Leave your feedback..."
                                  style="
                                    min-height: 120px;
                                    max-height: calc(100dvh - 300px);
                                  "
                                ></textarea>
                              </div>

                              <!-- Button -->
                              <div
                                class="flex font-medium w-full px-4 py-4 max-w-[640px]"
                              >
                                <button
                                  [disabled]="isEditLoading"
                                  (click)="submitEditReview()"
                                  class="bg-[#0F5EE4] text-2xl px-4 py-4 rounded-full text-white w-full flex items-center justify-center gap-2"
                                >
                                  <ng-container *ngIf="!isEditLoading">
                                    <i class="fas fa-save mr-1"></i> Save
                                  </ng-container>
                                  <ng-container *ngIf="isEditLoading">
                                    <i class="fas fa-spinner fa-spin mr-1"></i>
                                    Saving
                                  </ng-container>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                        <ng-container
                          *ngIf="
                            !(
                              existingUserReview &&
                              review._id === existingUserReview._id &&
                              isDeleteLoading
                            );
                            else deletingReviewLoaderMobile
                          "
                        >
                          <!-- Edit/Delete Buttons for User's Review -->
                          <ng-container
                            *ngIf="
                              existingUserReview &&
                              review._id === existingUserReview._id &&
                              !isEditingReview
                            "
                          >
                            <button
                              (click)="toggleEditReview(review)"
                              class="absolute bottom-3.5 right-[1rem] text-gray-400 transition"
                            >
                              <i class="fas fa-edit text-2xl"></i>
                            </button>
                            <button
                              (click)="showdeleteConfirmation(review)"
                              class="absolute bottom-3.5 left-[1rem] text-gray-400 transition"
                            >
                              <i class="fas fa-trash text-[1.3rem]"></i>
                            </button>
                          </ng-container>

                          <div class="flex items-start mt-[1rem]">
                            <!-- Profile Picture -->
                            <img
                              [src]="
                                review.user.profilePicture || 'assets/user.png'
                              "
                              alt="Profile Picture"
                              (click)="goToProfile(review.user._id)"
                              class="w-[4rem] h-[4rem] rounded-full object-cover"
                            />

                            <!-- Username and Review Info -->
                            <div class="ml-3 flex-1">
                              <p
                                class="text-white text-lg textFixUsername font-medium pr-[.8rem]"
                              >
                                {{
                                  existingUserReview &&
                                  review._id === existingUserReview._id
                                    ? "Your Review"
                                    : review.user.username
                                }}
                              </p>
                              <p
                                class="text-gray-400 text-sm textFixCreatedAtDate"
                              >
                                {{ review.createdAt | date : "short" }}
                              </p>
                            </div>

                            <!-- Rating Badge -->
                            <p
                              class="rating-badge text-white text-lg rounded-md px-3 py-1.5 text-center"
                              style="width: 6.95rem"
                            >
                              <i class="fas fa-star text-yellow-400"></i>
                              {{ review.rating }} / 10
                            </p>
                          </div>

                          <!-- Review Text -->
                          <div
                            class="mt-3 px-2"
                            [ngClass]="{
                              'pb-[4rem]':
                                existingUserReview &&
                                review._id === existingUserReview._id
                            }"
                          >
                            <p class="text-gray-400 text-lg break-words">
                              {{ review.reviewText }}
                            </p>
                          </div>
                        </ng-container>

                        <ng-template #deletingReviewLoaderMobile>
                          <div
                            class="flex items-center justify-center h-16 bg-gray-800 rounded-lg p-4"
                          >
                            <i
                              class="fas fa-spinner fa-spin text-gray-400 text-xl"
                            ></i>
                            <span class="ml-2 text-gray-300 text-lg"
                              >Deleting...</span
                            >
                          </div>
                        </ng-template>
                      </li>
                    </ul>
                    <div
                      class="px-4 py-3 bg-[#1e1f22] border-t border-gray-700 rounded-b-md text-base text-white flex flex-col items-center"
                      *ngIf="totalPages > 1"
                    >
                      <span class="mb-2 font-medium text-base text-gray-400"
                        >Page</span
                      >
                      <div class="flex gap-2">
                        <button
                          *ngFor="
                            let p of [].constructor(totalPages);
                            let i = index
                          "
                          (click)="changePage(i + 1)"
                          [ngClass]="{
                            'bg-indigo-600': page === i + 1,
                            'bg-gray-600': page !== i + 1
                          }"
                          class="px-3 py-1 rounded text-sm font-medium text-white transition"
                        >
                          {{ i + 1 }}
                        </button>
                      </div>
                    </div>
                  </div>
                </ng-container>
                <ng-template #noReviewsDesktop>
                  <p class="text-gray-400 mt-8 pb-5 text-center text-xl">
                    No reviews yet.
                  </p>
                </ng-template>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
