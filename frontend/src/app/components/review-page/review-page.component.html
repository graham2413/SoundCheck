<!-- MOBILE MODAL -->
<div
  *ngIf="isModalOpen"
  #modalScrollContainer
  class="fixed inset-0 flex flex-col text-white overflow-y-auto md:hidden z-50 gradient-background"
  @slideUp
  [ngStyle]="{ background: backgroundGradient }"
>
  <!--iPod Container -->
  <div
    class="flex flex-col w-full flex-shrink-0 justify-between"
    style="height: 100dvh"
  >
    <!--iPod Back -->
    <div
      [@slideAnimation]="showSecondIpod ? 'back' : 'hidden'"
      [ngClass]="{ 'invisible-view': !showSecondIpod }"
      *ngIf="showSecondIpod"
    >
      <!-- Back Button (top-left) -->
      <button
        (click)="onBackClick()"
        class="absolute top-4 left-4 w-[3rem] h-[3rem] sm:w-14 sm:h-14 rounded-full bg-white flex items-center justify-center shadow-md z-50"
      >
        <i class="fas fa-chevron-left text-[#09101F] text-2xl sm:text-3xl"></i>
      </button>

      <!-- Close Button (top-right) -->
      <button
        (click)="close()"
        class="absolute top-4 right-4 w-[3rem] h-[3rem] sm:w-14 sm:h-14 rounded-full bg-white flex items-center justify-center shadow-md z-50"
      >
        <i class="fas fa-times text-[#09101F] text-2xl sm:text-3xl"></i>
      </button>

      <!-- Artist Section -->
      <div *ngIf="record.type === 'Artist'">
        <div class="relative mt-[5rem] left-0 right-0 z-50">
          <div
            class="relative flex bg-gray-800 rounded-full p-1 w-fit mx-auto mb-5 mt-2"
          >
            <!-- Sliding Highlight -->
            <div
              class="absolute top-0 left-0 h-full w-1/2 bg-[#0F5EE4] rounded-full transition-all duration-300"
              [ngStyle]="{
                transform:
                  activeTab === 'All Releases'
                    ? 'translateX(100%)'
                    : 'translateX(0%)'
              }"
            ></div>

            <!-- Top Tracks Button -->
            <button
              class="relative z-10 w-[8rem] sm:w-[10rem] py-2 sm:py-3 text-lg sm:text-xl font-semibold rounded-full transition text-center"
              [ngClass]="{
                'text-white': activeTab === 'Top Tracks',
                'text-gray-300': activeTab !== 'Top Tracks'
              }"
              (click)="activeTab = 'Top Tracks'"
            >
              Top Tracks
            </button>

            <!-- All Releases Button -->
            <button
              class="relative z-10 w-32 sm:w-[10rem] py-2 sm:py-3 text-lg sm:text-xl font-semibold rounded-full transition text-center"
              [ngClass]="{
                'text-white': activeTab === 'All Releases',
                'text-gray-300': activeTab !== 'All Releases'
              }"
              (click)="activeTab = 'All Releases'"
              [disabled]="isLoadingExtraDetails"
            >
              All Releases
            </button>
          </div>

          <!-- Top Tracks Tracklist -->
          <div *ngIf="activeTab === 'Top Tracks'" class="px-2">
            <ul
              *ngIf="isTracklistArray"
              class="w-full mt-1 mb-3 rounded-lg space-y-3"
            >
              <li
                *ngFor="let track of record.tracklist; let i = index"
                class="flex items-center justify-between py-2 px-2 rounded-xl transition-all duration-300 bg-gray-800"
                [ngClass]="{
                  'opacity-50': !track.preview || track.preview.length <= 1,
                  'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
                }"
              >
                <!-- Album Image -->
                <div
                  class="relative w-[5rem] h-[5rem] sm:w-[8rem] sm:h-[8rem] flex-shrink-0 mr-2"
                >
                  <!-- Spinner -->
                  <div
                    *ngIf="!isTrackImageLoaded(i)"
                    class="absolute inset-0 z-10 flex items-center justify-center bg-gray-800 border border-gray-700 rounded-md"
                  >
                    <div
                      class="w-5 h-5 border-t-2 border-white rounded-full animate-spin"
                    ></div>
                  </div>

                  <!-- Image -->
                  <img
                    (click)="openSongOrAlbum(track)"
                    (load)="markTrackImageLoaded(i)"
                    (error)="markTrackImageLoaded(i)"
                    [src]="
                      track.cover ||
                      'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                    "
                    [style.opacity]="isTrackImageLoaded(i) ? '1' : '0'"
                    class="w-full h-full object-cover rounded-md border-2 border-gray-500 transition-opacity duration-300"
                    alt="Album Cover"
                  />
                </div>

                <!-- Title and album info -->
                <div
                  class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
                >
                  <div class="flex items-center gap-2 min-w-0 text-xl">
                    <span
                      (click)="openSongOrAlbum(track)"
                      class="text-white text-base sm:text-xl truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                    >
                      <span
                        *ngIf="track.isExplicit"
                        class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.3em] sm:text-lg flex items-center justify-center font-bold rounded leading-none shrink-0"
                      >
                        E
                      </span>
                      <span
                        class="pl-1 pr-2 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                        >{{ track.title }}</span
                      >
                    </span>
                  </div>
                  <div
                    (click)="openSongOrAlbum(track)"
                    class="flex items-center gap-2 text-gray-500 text-sm sm:text-base"
                  >
                    <span
                      class="truncate overflow-hidden whitespace-nowrap block flex-1 pr-2"
                      [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                    >
                      {{ track.album }}
                    </span>
                  </div>
                </div>

                <!-- Play Button -->
                <ng-container *ngIf="track.preview && track.preview.length > 1">
                  <div
                    class="flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 bg-gray-500 text-white rounded-full px-3 transition-all duration-300"
                    [ngClass]="{
                      'transition-all duration-300 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                        track.isPlaying
                    }"
                    (click)="playTrack(track)"
                  >
                    <i
                      [ngClass]="{
                        fas: true,
                        'fa-pause': track.isPlaying,
                        'fa-play': !track.isPlaying
                      }"
                      class="text-lg sm:text-2xl transition-all duration-300"
                    >
                    </i>
                  </div>
                </ng-container>
              </li>
            </ul>

            <!-- Loading state -->
            <div
              *ngIf="isLoadingExtraDetails"
              class="w-full bg-gray-800 p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
            >
              <p class="text-gray-400 text-center mb-4 text-lg">
                Loading Artist Tracks...
              </p>
              <div
                class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
              ></div>
            </div>

            <!-- No tracklist -->
            <div
              *ngIf="!isLoadingExtraDetails && !isTracklistArray"
              class="w-full bg-gray-800 p-6 rounded-lg text-center"
            >
              <p class="text-gray-400">Top Tracks Unavailable.</p>
            </div>
          </div>
        </div>
        <!-- All Releases View -->
        <div *ngIf="activeTab === 'All Releases'" class="px-2">
          <div
            class="grid grid-cols-2 sm:grid-cols-3 gap-4 p-2 mb-3 rounded-lg"
          >
            <div
              *ngFor="let release of releases; let i = index"
              class="text-center bg-gray-800 p-3 rounded-lg"
              (click)="openSongOrAlbum(release)"
            >
              <div class="relative aspect-square w-full">
                <!-- Spinner -->
                <div
                  *ngIf="!isReleaseImageLoaded(i)"
                  class="absolute inset-0 z-10 flex items-center justify-center bg-gray-800 border border-gray-700 rounded-md"
                >
                  <div
                    class="w-5 h-5 border-t-2 border-white rounded-full animate-spin"
                  ></div>
                </div>

                <!-- Image -->
                <img
                  [src]="
                    release.cover ||
                    'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                  "
                  (load)="markReleaseImageLoaded(i)"
                  (error)="markReleaseImageLoaded(i)"
                  [style.opacity]="isReleaseImageLoaded(i) ? '1' : '0'"
                  class="aspect-square w-full object-cover rounded-md border-2 border-gray-500 transition-opacity duration-300"
                  alt="Release Cover"
                />
              </div>

              <div class="mt-2 flex justify-center">
                <span
                  *ngIf="release.isExplicit"
                  class="bg-gray-600 text-white mt-[.1rem] sm:mt-[.2rem] sm:text-sm text-xs w-[1rem] h-[1rem] flex items-center justify-center font-bold rounded leading-none shrink-0 mr-1"
                >
                  E
                </span>

                <!-- Container with max width and truncate behavior -->
                <span
                  class="text-white font-semibold text-sm sm:text-base truncate overflow-hidden whitespace-nowrap max-w-[80%] block"
                  [title]="release.title"
                >
                  {{ release.title }}
                </span>
              </div>

              <p class="text-gray-400 text-xs sm:text-sm">
                {{ release.releaseDate | date : "yyyy" }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Album and Song Section  -->
      <div *ngIf="record.type !== 'Artist'">
        <div class="relative flex justify-center items-center">
          <img
            [src]="
              record.cover ||
              'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
            "
            class="w-[55%] h-auto rounded-md mt-[2rem] border-2 border-gray-500"
            alt="Record Image"
          />
        </div>
        <div class="px-2">
          <div
            *ngIf="!isLoadingExtraDetails"
            class="p-4 text-white w-full mt-[1rem] px-3 bg-gray-800 rounded-lg"
          >
            <div class="text-xl sm:text-3xl font-bold leading-snug mb-1">
              {{ record.title }}
            </div>
            <div
              *ngIf="record.type === 'Album'"
              class="text-base text-gray-400 pt-1"
            >
              <div class="text-base sm:text-xl text-gray-400 pt-1">
                Artist: <span class="text-white">{{ record.artist }}</span>
              </div>
            </div>

            <!-- Contributors -->
            <div *ngIf="record.contributors?.length">
              <div class="text-base sm:text-xl text-gray-400 pt-1">
                Contributors:
                <span class="text-white">{{
                  record.contributors?.join(", ")
                }}</span>
              </div>
            </div>

            <div class="text-base sm:text-xl text-gray-400 pt-1">
              Released:
              <span class="text-white">{{
                formatDate(record.releaseDate)
              }}</span>
            </div>
            <div
              *ngIf="record.type === 'Song'"
              class="text-base sm:text-xl text-gray-400 pt-1"
            >
              Album:
              <span class="text-white">{{ record.album }}</span>
            </div>
            <div class="text-base sm:text-xl text-gray-400 pt-1">
              Genre: <span class="text-white">{{ record.genre }}</span>
            </div>

            <div
              *ngIf="record.type === 'Song'"
              class="text-base sm:text-xl text-gray-400 pt-1"
            >
              Duration:
              <span class="text-white">
                {{ getSongDurationDisplay(record) }}
              </span>
            </div>

            <div
              *ngIf="record.type === 'Album'"
              class="text-base text-gray-400 pt-1"
            >
              <div class="text-base sm:text-xl text-gray-400 pt-1">
                <ng-container
                  *ngIf="trackSummary?.count === 1; else multipleTracks"
                >
                  Duration:
                </ng-container>
                <ng-template #multipleTracks>
                  <span class="text-white">{{ trackSummary?.count }}</span>
                  {{ trackSummary?.count === 1 ? " song" : " songs" }} ·
                </ng-template>
                <span class="text-white">{{
                  trackSummary?.durationDisplay
                }}</span>
              </div>
            </div>
          </div>
          <!-- Album Tracklist -->
          <ul
            *ngIf="
              isTracklistArray &&
              record.type === 'Album' &&
              record.tracklist &&
              record.tracklist.length > 1
            "
            class="space-y-3 w-full mt-3  mb-3 rounded-lg"
          >
            <li
              *ngFor="let track of record.tracklist; let i = index"
              class="flex items-center justify-between py-3 px-1 rounded-xl transition-all duration-300 bg-gray-800"
              [ngClass]="{
                'opacity-50': !track.preview || track.preview.length <= 1,
                'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
              }"
            >
              <!-- Play Button -->
              <ng-container *ngIf="track.preview && track.preview.length > 1">
                <div
                  class="flex items-center justify-center w-12 h-12 sm:w-16 sm:h-16 bg-gray-500 text-white rounded-full mr-3 ml-1 px-3 transition-all duration-300"
                  [ngClass]="{
                    'transition-all duration-700 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                      track.isPlaying
                  }"
                  (click)="playTrack(track)"
                >
                  <i
                    [ngClass]="{
                      fas: true,
                      'fa-pause': track.isPlaying,
                      'fa-play': !track.isPlaying
                    }"
                    class="text-xl sm:text-2xl transition-all duration-700"
                  >
                  </i>
                </div>
              </ng-container>

              <!-- Title and album info -->
              <div
                class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
              >
                <div class="flex items-center gap-2 min-w-0 text-xl">
                  <span
                    (click)="openSongOrAlbum(track)"
                    class="text-white text-lg sm:text-xl truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                  >
                    <span
                      *ngIf="track.isExplicit"
                      class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.3em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                    >
                      E
                    </span>
                    <span
                      class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                      >{{ track.title }}</span
                    >
                  </span>
                </div>
              </div>

              <!-- Duration -->
              <span
                (click)="openSongOrAlbum(track)"
                class="text-white bg-gray-500 text-base sm:text-lg shrink-0 ml-2.5 mr-2 p-1 px-1.5 rounded-md"
              >
                {{ formatDuration(track.duration) || "?" }}
              </span>
            </li>
          </ul>

          <!-- Loading state -->
          <div
            *ngIf="isLoadingExtraDetails"
            class="w-full bg-gray-800 p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
          >
            <p class="text-gray-400 text-center mb-4 text-lg">Loading...</p>
            <div
              class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
            ></div>
          </div>

          <!-- No tracklist -->
          <div
            *ngIf="
              !isLoadingExtraDetails &&
              !isTracklistArray &&
              record.type === 'Album'
            "
            class="w-full bg-[#09101F] p-6 rounded-lg text-center"
          >
            <p class="text-gray-400">No tracklist available.</p>
          </div>
        </div>
      </div>
    </div>

    <!--iPod Front -->
    <div
      [@slideAnimation]="showSecondIpod ? 'hidden' : 'front'"
      [ngClass]="{ 'invisible-view': showSecondIpod }"
      class="absolute inset-0 flex flex-col w-full h-[100dvh] min-h-0"
      #iPodFront
    >
      <div class="w-full flex flex-col flex-grow min-h-0">
        <div
          class="flex justify-between items-center px-4 w-full min-h-[60px] pt-1 topBar"
        >
          <!-- Info Button -->
          <button
            (click)="showSecondIpod = true"
            class="w-[4rem] h-[3rem] sm:w-[5rem] sm:h-[4rem] rounded-full bg-white flex items-center justify-center shadow-md"
          >
            <span
              class="text-[#09101F] text-3xl sm:text-4xl"
              style="font-weight: 500; line-height: 0.9"
              >i</span
            >
          </button>

          <!-- Overall Rating -->
          <div class="flex justify-center w-full my-4">
            <div
              class="bg-gray-800 px-4 py-3 rounded-lg w-full mx-auto max-w-[85%] sm:max-w-[70%] min-w-[180px]"
            >
              <div
                class="flex flex-col items-center justify-center text-center"
              >
                <ng-container
                  *ngIf="
                    !isRatingLoaded ||
                      isDeleteLoading ||
                      isEditLoading ||
                      isCreateLoading;
                    else ratingAvailable
                  "
                >
                  <!-- Loading Spinner -->
                  <div
                    class="animate-pulse rounded w-full h-16 flex items-center justify-center"
                  >
                    <i
                      class="fas fa-spinner fa-spin text-gray-400 text-3xl"
                    ></i>
                  </div>
                </ng-container>

                <ng-template #ratingAvailable>
                  <ng-container
                    *ngIf="getAverageRating() > 0; else noReviewsMessage"
                  >
                    <!-- Rating Badge -->
                    <div
                      (click)="scrollToReviews()"
                      class="rating-badge-bg px-3 py-1 rounded-full text-white text-3xl font-bold tracking-wide shadow mb-2 flex items-center justify-center"
                    >
                      <ng-container
                        *ngIf="getAverageRating() === 10; else formattedRating"
                      >
                        10
                      </ng-container>
                      <ng-template #formattedRating>
                        {{ getAverageRating() | number : "1.1-1" }}
                      </ng-template>
                      <span class="text-lg font-medium text-gray-300 ml-1"
                        >/ 10</span
                      >
                    </div>

                    <!-- Progress Bar -->
                    <div
                      class="mt-1 w-full bg-gray-700 h-3 rounded-full overflow-hidden"
                    >
                      <div
                        class="h-3 rounded-full transition-all duration-700 ease-out"
                        [style.width.%]="ratingBarFill"
                        [style.background]="getRatingGradient()"
                      ></div>
                    </div>
                  </ng-container>
                </ng-template>
              </div>
            </div>
          </div>

          <!-- No Reviews Star Rating Prompt -->
          <ng-template #noReviewsMessage>
            <div
              class="flex flex-col items-center justify-center text-gray-300"
            >
              <div class="inline-flex space-x-1" (click)="scrollToReviews()">
                <i class="far fa-star text-2xl sm:text-3xl"></i>
                <i class="far fa-star text-2xl sm:text-3xl"></i>
                <i class="far fa-star text-2xl sm:text-3xl"></i>
                <i class="far fa-star text-2xl sm:text-3xl"></i>
                <i class="far fa-star text-2xl sm:text-3xl"></i>
              </div>
              <!-- Ensure only the text is clickable -->
              <span
                class="text-lg font-medium cursor-pointer"
                (click)="scrollToReviews()"
                >Be the first to rate!</span
              >
            </div>
          </ng-template>

          <!-- Close Button -->
          <button
            (click)="close()"
            class="w-[4rem] h-[3rem] sm:w-[5rem] sm:h-[4rem] rounded-full bg-white flex items-center justify-center shadow-md"
          >
            <i class="fas fa-times text-[#09101F] text-2xl sm:text-3xl"></i>
          </button>
        </div>

        <!-- Middle Section: Image + Info/Text -->
        <div
          class="flex-1 min-h-0 flex flex-col items-center justify-center overflow-hidden px-2"
        >
          <div
            class="relative max-w-[85%] w-full flex justify-center items-center"
          >
            <img
              [src]="
                record.type === 'Artist'
                  ? record.picture ||
                    'https://res.cloudinary.com/drbccjuul/image/upload/v1750168658/t74iybj36xjrifpp7wzc.png'
                  : record.cover ||
                    'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
              "
              [alt]="record.type === 'Artist' ? record.name : record.title"
              class="rounded-lg w-full max-w-[420px] max-h-[420px] object-contain imageHeight border border-gray-800"
              (load)="isImageLoaded = true"
            />

            <!-- Hidden Loader Image to trigger background gradient logic -->
            <img
              [src]="getImageUrl(true)"
              class="hidden"
              (load)="onImageLoad($event)"
              crossorigin="anonymous"
              loading="eager"
            />
          </div>

          <!-- Title/Text -->
          <div
            class="text-center text-[1.8rem] mt-4 text-gray-200 font-semibold bg-gray-800 rounded-xl p-2"
          >
            <ng-container *ngIf="record.type === 'Artist'">
              <span class="text-gray-400 text-xl block uppercase">Artist</span>
            </ng-container>
            <ng-container *ngIf="record.type === 'Album'">
              <span
                class="text-gray-400 text-xl block uppercase"
                *ngIf="isSingleAlbum"
              >
                Single
              </span>
              <span
                class="text-gray-400 text-xl block uppercase"
                *ngIf="!isSingleAlbum && (record.tracklist?.length ?? 0) > 1"
              >
                Album
              </span>
            </ng-container>
            <div
              class="title-wrapper"
              [class.masked]="isTextOverflowing"
              #scrollingWrapper
            >
              <div
                class="title-content"
                #scrollingContent
                [class.scroll-animate]="isTextOverflowing"
              >
                <span
                  *ngIf="record.type !== 'Artist'"
                  class="inline-block align-middle"
                >
                  {{ record.title }}
                </span>
                <span *ngIf="record.type === 'Artist'">{{ record.name }}</span>
              </div>
            </div>
            <p class="text-gray-400 text-xl flex items-center justify-center">
              <span
                *ngIf="isExplicit"
                class="bg-gray-600 text-white text-base w-[1.5em] h-[1.5em] flex items-center justify-center font-bold rounded leading-none mr-1"
              >
                E
              </span>
              <span
                class="truncate overflow-hidden whitespace-nowrap max-w-full px-2"
              >
                {{ record.type !== "Artist" ? record.artist : "" }}
              </span>
            </p>
          </div>
        </div>
        <app-audio-player
          *ngIf="record"
          [record]="record"
          [hidden]="showSecondIpod"
          [showForwardAndBackwardButtons]="showForwardAndBackwardButtons"
          #audioPlayerMobile
          [song]="currentSong"
          (next)="nextSong()"
          (previous)="prevSong()"
          (playStatus)="updatePlayStatus($event)"
          (playStarted)="onAudioPlayStarted($event)"
          [currentIndex]="currentIndex"
          [recordList]="recordList"
        ></app-audio-player>
      </div>
    </div>
  </div>

  <!-- Add Artist Button -->
  <div *ngIf="!showSecondIpod && record.type == 'Artist'">
    <button
      *ngIf="!isProfileLoading && !isInList"
      class="mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-indigo-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
      [disabled]="addingToList"
      (click)="addToArtistList(record)"
    >
      <ng-container *ngIf="!addingToList; else addingState">
        <i class="fas fa-plus-circle mr-2 text-2xl"></i>
        Follow Artist
      </ng-container>
    </button>

    <!-- Remove Artist Button -->
    <button
      *ngIf="!isProfileLoading && isInList"
      class="mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-bold py-2 mt-4 px-6 rounded-full flex items-center justify-center text-lg bg-red-500 hover:bg-red-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
      [disabled]="addingToList"
      (click)="removeFromArtistList(record)"
    >
      <ng-container *ngIf="!addingToList; else removingState">
        <i class="fas fa-trash text-2xl mr-2"></i> Remove Artist
      </ng-container>
    </button>

    <!-- Loading templates -->
    <ng-template #addingState>
      <i class="fas fa-spinner fa-spin mr-2"></i> Adding...
    </ng-template>

    <ng-template #removingState>
      <i class="fas fa-spinner fa-spin mr-2"></i> Removing...
    </ng-template>
  </div>

  <!-- Loading state while fetching smart link -->
  <div
    *ngIf="isLoadingSmartUrl && !showSecondIpod && record.type !== 'Artist'"
    class="mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-medium py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gray-700 opacity-75 animate-pulse"
  >
    <i class="fas fa-spinner fa-spin mr-2 text-2xl"></i>
    Loading link...
  </div>

  <!-- Actual smart link once available -->
  <a
    *ngIf="
      !isLoadingSmartUrl &&
      smartLinkUrl &&
      !showSecondIpod &&
      record.type !== 'Artist'
    "
    [href]="smartLinkUrl"
    target="_blank"
    rel="noopener noreferrer"
    (click)="openMusicAppClick($event)"
    class="mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-indigo-600 transition"
  >
    <i class="fas fa-headphones mr-2 text-2xl"></i>
    Open in Music App
  </a>

  <!-- Reviews Section -->
  <div
    #reviewsSection
    *ngIf="!showSecondIpod"
    class="bg-[#171a21] shadow-md w-full mx-auto mt-3"
  >
    <div
      class="sticky top-0 z-30 bg-[#000000] px-3 py-2 rounded-t-sm shadow-[rgba(0,0,0,0.2)_0px_2px_6px]"
    >
      <!-- Center: Reviews Header -->
      <div
        class="flex justify-center mb-4 pt-2 pb-2 border-b border-b-gray-500"
      >
        <h2 class="text-3xl font-semibold text-white">
          Reviews
          <span class="text-base text-gray-400 font-medium">
            {{
              combinedReviews.length > 0
                ? "(" + combinedReviews.length + ")"
                : ""
            }}
          </span>
        </h2>
      </div>

      <div class="relative w-full h-[40px] flex items-center justify-between">
        <!-- Left: Filter Button -->
        <div class="flex items-center">
          <ng-container *ngIf="isFilterActive(); else filterButton">
            <div class="flex items-center gap-2 text-amber-400 font-semibold">
              <i class="fas fa-filter text-lg ml-2"></i>
              <span class="capitalize text-lg"
                >Filtered: {{ activeFilter }}</span
              >
              <button
                (click)="clearFilter()"
                class="text-gray-300 hover:text-white transition"
                aria-label="Clear Filter"
              >
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
          </ng-container>

          <ng-template #filterButton>
            <button
              (click)="toggleFilterMenu()"
              [disabled]="combinedReviews.length <= 1"
              class="flex items-center gap-1 text-lg font-semibold"
              [ngClass]="{
                'text-amber-400': combinedReviews.length > 1,
                'text-white': combinedReviews.length <= 1
              }"
            >
              <i class="fas fa-filter text-lg mr-1 ml-2"></i>
              <span>Filter</span>
            </button>
          </ng-template>
        </div>

        <!-- Right: Add Button -->
        <div *ngIf="!isAddingReview && isReviewsLoaded">
          <button
            (click)="toggleReviewForm()"
            [disabled]="existingUserReview"
            [ngClass]="{
              'bg-gradient-to-r from-sky-500 to-blue-600 text-white': !existingUserReview,
              'bg-gray-500 text-gray-300': existingUserReview
            }"
            class="flex items-center gap-1 px-3 py-1 rounded-md font-medium text-lg"
          >
            <i class="fas fa-plus-circle text-lg mr-1"></i>
            <span class="mr-2">Add</span>
          </button>
        </div>
      </div>
    </div>

    <div>
      <ng-container *ngIf="!isReviewsLoaded; else reviewsContentMobile">
        <div class="space-y-3 mt-3 px-2 pb-2">
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
          <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
        </div>
      </ng-container>

      <ng-template #reviewsContentMobile>
        <!-- Fullscreen Overlay for Creating -->
        <div
          *ngIf="isAddingReview"
          @overlayAnimation
          class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
          style="height: 100dvh"
        >
          <div
            class="bg-[#1c2127] shadow-lg flex flex-col items-center justify-between"
            style="width: 100vw; height: 100dvh"
          >
            <!-- Header with Back Button -->
            <div
              class="relative w-full h-[64px] flex items-center justify-center px-4"
            >
                    <button
                    [disabled]="isCreateLoading"
                    (click)="cancelReview()"
                    class="w-10 h-10 sm:w-14 sm:h-14 sm:mt-3 flex items-center justify-center absolute left-4 rounded-full"
                    style="background: #2d323a"
                    >
                    <i class="fas fa-times text-2xl sm:text-3xl text-white"></i>
                    </button>
              <p class="text-white font-semibold text-2xl sm:text-3xl text-center mt-[2rem]">
                Write Review
              </p>
            </div>

            <!-- Rating Section -->
            <div
              class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden"
            >
              <div class="text-center w-full mx-auto">
                <!-- Star Rating Display -->
                <div class="flex justify-center mb-4 gap-1">
                  <ng-container
                    *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                  >
                    <ng-container [ngSwitch]="getStarType(star, newRating)">
                      <i
                        *ngSwitchCase="'full'"
                        class="fas fa-star text-2xl text-yellow-400 star-size"
                      ></i>
                      <i
                        *ngSwitchCase="'half'"
                        class="fas fa-star-half-alt text-2xl text-yellow-400 star-size"
                      ></i>
                      <i
                        *ngSwitchCase="'empty'"
                        class="far fa-star text-2xl text-gray-500 star-size"
                      ></i>
                    </ng-container>
                  </ng-container>
                </div>

                <p class="text-white font-medium text-xl mb-2 text-center">
                  Rating:
                  <input
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    [(ngModel)]="newRating"
                    (keypress)="onKeyPressRating($event, 'new')"
                    (blur)="onBlurRating('new')"
                    class="w-[3.2rem] text-[1.5rem] leading-none text-yellow-400 bg-[#2d323a] border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded mr-2"
                  />
                  <span
                    class="text-gray-300 text-[1.3rem] opacity-70 font-medium"
                    >/ 10</span
                  >
                </p>

                <!-- Slider -->
                <input
                  type="range"
                  min="0"
                  max="10"
                  step="0.1"
                  [(ngModel)]="newRating"
                  [style.background]="getSliderBackground(newRating)"
                  class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern my-3"
                />
              </div>

              <!-- Textarea -->
              <textarea
                [(ngModel)]="newReview"
                [disabled]="isCreateLoading"
                class="w-full flex-grow mt-5 p-3 text-lg sm:text-2xl bg-[#14171a] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                placeholder="Leave your feedback..."
                style="min-height: 120px; max-height: calc(100dvh - 300px)"
              ></textarea>

              <!-- Submit Button -->
              <div class="flex font-medium w-full mt-[2rem] pb-3">
                <button
                  [disabled]="isCreateLoading"
                  (click)="submitReview()"
                  class="bg-gradient-to-r from-sky-500 to-blue-600 text-2xl px-4 py-4 rounded-2xl text-white w-full flex items-center justify-center gap-2"
                >
                  <ng-container *ngIf="!isCreateLoading">
                    <i class="fas fa-paper-plane"></i> Create
                  </ng-container>
                  <ng-container *ngIf="isCreateLoading">
                    <i class="fas fa-spinner fa-spin"></i> Creating
                  </ng-container>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- All Reviews Section -->
        <div>
          <ng-container
            *ngIf="
              existingUserReview || filteredReviews.length > 0;
              else noReviewsMobile
            "
          >
            <ul class="space-y-4 mt-1 bg-[#171a21] px-2" @fadeIn>
              <li
                *ngFor="
                  let review of pagedReviews;
                  let i = index;
                  trackBy: trackById
                "
                class="review-card p-2 flex flex-col gap-2 relative bg-[#171a21]"
                [ngClass]="{
                  'border-b border-gray-500': i < pagedReviews.length - 1
                }"
              >
                <!-- Fullscreen Overlay for Editing -->
                <div
                  *ngIf="isEditingReview"
                  @overlayAnimation
                  class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"
                  style="height: 100dvh"
                >
                  <div
                    class="bg-[#1c2127] shadow-lg flex flex-col items-center justify-between"
                    style="width: 100vw; height: 100dvh"
                  >
            <!-- Header with Back Button -->
            <div
              class="relative w-full h-[64px] flex items-center justify-center px-4"
            >
                    <button
                    [disabled]="isEditLoading"
                    (click)="cancelEditReview()"
                    class="w-10 h-10 sm:w-14 sm:h-14 sm:mt-3 flex items-center justify-center absolute left-4 rounded-full"
                    style="background: #2d323a"
                    >
                    <i class="fas fa-times text-2xl sm:text-3xl text-white"></i>
                    </button>
              <p class="text-white font-semibold text-2xl sm:text-3xl text-center mt-[2rem]">
                Edit Review
              </p>
            </div>

                    <!-- Edit Rating Section -->
                    <div
                      class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden"
                    >
                      <div class="text-center w-full mx-auto">
                        <!-- Star Rating Display -->
                        <div class="flex justify-center mb-4 gap-1">
                          <ng-container
                            *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                          >
                            <ng-container
                              [ngSwitch]="getStarType(star, editedRating)"
                            >
                              <i
                                *ngSwitchCase="'full'"
                                class="fas fa-star text-2xl text-yellow-400 star-size"
                              ></i>
                              <i
                                *ngSwitchCase="'half'"
                                class="fas fa-star-half-alt text-2xl text-yellow-400 star-size"
                              ></i>
                              <i
                                *ngSwitchCase="'empty'"
                                class="far fa-star text-2xl text-gray-500 star-size"
                              ></i>
                            </ng-container>
                          </ng-container>
                        </div>

                        <p
                          class="text-white font-medium text-xl mb-2 text-center"
                        >
                          Rating:
                          <input
                            type="number"
                            min="0"
                            max="10"
                            step="0.1"
                            [(ngModel)]="editedRating"
                            (keypress)="onKeyPressRating($event, 'edit')"
                            (blur)="onBlurRating('edit')"
                            class="w-[3.2rem] text-[1.5rem] leading-none text-yellow-400 bg-[#2d323a] border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                          />
                          <span
                            class="text-gray-300 text-[1.3rem] opacity-70 font-medium"
                            >/ 10</span
                          >
                        </p>

                        <!-- Slider -->
                        <input
                          type="range"
                          min="0"
                          max="10"
                          step="0.1"
                          [(ngModel)]="editedRating"
                          [style.background]="getSliderBackground(editedRating)"
                          class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern my-3"
                        />
                      </div>

                      <!-- Textarea -->
                      <textarea
                        [(ngModel)]="editedReviewText"
                        [disabled]="isEditLoading"
                        class="w-full flex-grow mt-5 p-3 text-lg sm:text-2xl bg-[#14171a] rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                        placeholder="Leave your feedback..."
                        style="
                          min-height: 120px;
                          max-height: calc(100dvh - 300px);
                        "
                      ></textarea>

                      <!-- Submit Button -->
                      <div class="flex font-medium w-full mt-[2rem] pb-3">
                        <button
                          [disabled]="isEditLoading"
                          (click)="submitEditReview()"
                          class="bg-gradient-to-r from-sky-500 to-blue-600 text-2xl px-4 py-4 rounded-2xl text-white w-full flex items-center justify-center gap-2"
                        >
                          <ng-container *ngIf="!isEditLoading">
                            <i class="fas fa-save mr-1"></i> Save
                          </ng-container>
                          <ng-container *ngIf="isEditLoading">
                            <i class="fas fa-spinner fa-spin mr-1"></i> Saving
                          </ng-container>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-container
                  *ngIf="
                    !(
                      existingUserReview &&
                      review._id === existingUserReview._id &&
                      isDeleteLoading
                    );
                    else deletingReviewLoaderMobile
                  "
                >
                  <!-- Edit/Delete Buttons for User's Review -->
                  <ng-container
                    *ngIf="
                      existingUserReview &&
                      review._id === existingUserReview._id &&
                      !isEditingReview
                    "
                  >
                    <button
                      (click)="toggleEditReview(review)"
                      class="absolute bottom-3.5 right-[1rem] text-gray-400 transition"
                    >
                      <i class="fas fa-edit text-2xl"></i>
                    </button>
                    <button
                      (click)="showdeleteConfirmation(review)"
                      class="absolute bottom-3.5 left-[1rem] text-gray-400 transition"
                    >
                      <i class="fas fa-trash text-[1.3rem]"></i>
                    </button>
                  </ng-container>

                  <div class="flex items-start mt-[1rem]">
                    <!-- Profile Picture -->
                    <img
                      [src]="
                        review.user.profilePicture
                          ? transformCloudinaryUrl(review.user.profilePicture)
                          : 'assets/user.png'
                      "
                      alt="Profile Picture"
                      class="w-[4rem] h-[4rem] rounded-full object-cover"
                      (click)="goToProfile(review.user._id)"
                    />
                    <!-- Username and Review Info -->
                    <div class="ml-3 flex-1">
                      <p class="text-white text-lg font-semibold pr-[.8rem]">
                        {{
                          existingUserReview &&
                          review._id === existingUserReview._id
                            ? "Your Review"
                            : review.user.username
                        }}
                      </p>
                      <p class="text-gray-400 text-sm">
                        {{ review.createdAt | date : "short" }}
                      </p>
                    </div>

                    <!-- Rating Badge -->
                    <p
                      class="rating-badge text-white text-lg rounded-md px-3 py-1.5 text-center"
                      style="width: 6.95rem"
                    >
                      <i class="fas fa-star text-yellow-400"></i>
                      {{ review.rating }} / 10
                    </p>
                  </div>

                  <!-- Review Text -->
                  <div
                    class="mt-3 px-1"
                    [ngClass]="{
                      'pb-[4rem]':
                        existingUserReview &&
                        review._id === existingUserReview._id
                    }"
                  >
                    <p
                      class="text-white text-lg break-words"
                      *ngIf="
                        review.reviewText &&
                          review.reviewText.trim().length > 0;
                        else noReviewText
                      "
                    >
                      {{ review.reviewText }}
                    </p>
                    <ng-template #noReviewText>
                      <p
                        class="text-gray-400 italic text-base md:text-xl mt-2 font-serif"
                      >
                        “ No review written ”
                      </p>
                    </ng-template>

                    <div class="flex justify-end mt-2 px-1">
                      <button
                        (click)="toggleLike(review)"
                        class="flex items-center space-x-2 px-3 py-1 bg-gray-800 border border-gray-600 rounded-full text-white hover:bg-gray-700 transition"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          [attr.fill]="
                            review.likedByCurrentUser ? '#ec4899' : 'white'
                          "
                          viewBox="0 0 24 24"
                          class="w-5 h-5 transition-transform duration-300 ease-out"
                          [ngClass]="
                            animateHeart[review._id] ? 'scale-125' : ''
                          "
                        >
                          <path
                            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                            2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 
                            C13.09 3.81 14.76 3 16.5 3c3.08 0 5.5 2.42 5.5 5.5 
                            0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                          />
                        </svg>

                        <span class="text-yellow-400 font-semibold text-lg">
                          {{ review.likes }}
                        </span>
                      </button>
                    </div>
                  </div>
                </ng-container>

                <ng-template #deletingReviewLoaderMobile>
                  <div
                    class="flex items-center justify-center h-16 bg-gray-800 rounded-lg p-4"
                  >
                    <i class="fas fa-spinner fa-spin text-gray-400 text-xl"></i>
                    <span class="ml-2 text-gray-300 text-lg">Deleting...</span>
                  </div>
                </ng-template>
              </li>
            </ul>
            <div
              class="mt-4 mb-3 px-4 py-3 bg-[#1e1f22] border-t border-gray-700 rounded-b-md text-base text-white flex flex-col items-center"
              *ngIf="totalPages > 1"
            >
              <span class="mb-2 font-medium text-base text-gray-400">Page</span>
              <div class="flex gap-2">
                <button
                  *ngFor="let p of [].constructor(totalPages); let i = index"
                  (click)="changePage(i + 1)"
                  [ngClass]="{
                    'bg-indigo-600': page === i + 1,
                    'bg-gray-600': page !== i + 1
                  }"
                  class="px-3 py-1 rounded text-sm font-medium text-white transition"
                >
                  {{ i + 1 }}
                </button>
              </div>
            </div>
          </ng-container>

          <ng-template #noReviewsMobile>
            <p class="text-gray-400 mt-8 pb-5 text-center text-xl">
              No reviews yet.
            </p>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<div
  *ngIf="filterMenuOpen"
  class="fixed inset-0 z-[9999] bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center px-4"
  (click)="clearFilter()"
>
  <div
    class="relative bg-[#1e1f22] rounded-2xl shadow-xl px-6 py-7 w-full max-w-sm flex flex-col items-center gap-5"
    (click)="$event.stopPropagation()"
  >
    <!-- Close Button -->
    <button
      (click)="clearFilter()"
      class="absolute top-4 left-4 text-gray-400 hover:text-white text-2xl transition"
    >
      <i class="fas fa-times"></i>
    </button>

    <h3 class="text-white text-2xl mt-3 font-semibold tracking-wide">
      Filter Reviews
    </h3>

    <button
      (click)="applyFilter('newest')"
      class="w-full bg-[#0F5EE4] hover:bg-[#0D51CC] active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-clock"></i> Newest First
    </button>

    <button
      (click)="applyFilter('highest')"
      class="w-full bg-green-500 hover:bg-green-600 active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-star"></i> Highest Rated
    </button>

    <button
      (click)="applyFilter('lowest')"
      class="w-full bg-red-500 hover:bg-red-600 active:scale-95 text-white py-3 rounded-lg text-base font-semibold transition flex items-center justify-center gap-2"
    >
      <i class="fas fa-arrow-down"></i> Lowest Rated
    </button>
  </div>
</div>

<!-- SEPARATION OF THE MODALS -->

<!-- DESKTOP/TABLET MODAL -->
<div
  @slideUp
  *ngIf="isModalOpen"
  class="hidden md:flex min-h-[95vh] fixed inset-0 items-center justify-center bg-black bg-opacity-50 overflow-y-auto custom-scrollbar z-50"
>
  <div
    class="relative bg-[#1E1E1E] text-white w-[95%] max-w-[1300px] sm:rounded-xl shadow-lg p-3 flex flex-col h-[95vh] min-h-0 overflow-hidden"
  >
    <!-- Exit Button -->
    <button
      (click)="close()"
      class="absolute top-3 right-3 bg-gray-800 hover:bg-gray-700 text-white w-[4rem] h-[4rem] rounded-full flex items-center justify-center transition border-2 border-white shadow-lg"
    >
      <i class="fas fa-times text-xl"></i>
    </button>

    <!-- Info Button -->
    <button
      (click)="showSecondIpod = !showSecondIpod"
      class="absolute top-3 left-3 bg-gray-800 hover:bg-gray-700 text-white w-[4rem] h-[4rem] rounded-full flex items-center justify-center transition border-2 border-white shadow-lg"
    >
      <span
        *ngIf="!showSecondIpod"
        class="text-white text-3xl"
        style="font-weight: 500; line-height: 0.9"
        >i</span
      >
      <i
        *ngIf="showSecondIpod"
        class="fas fa-chevron-left text-xl"
        style="color: white"
      ></i>
    </button>

    <!-- Overall Rating Circle -->
    <div class="flex justify-center w-full">
      <ng-container
        *ngIf="
          !isRatingLoaded ||
            isCreateLoading ||
            isEditLoading ||
            isDeleteLoading;
          else ratingContentDesktop
        "
      >
        <!-- Loading State (Spinner) -->
        <div
          class="animate-pulse bg-gray-600 rounded-full w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <i
            class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
          ></i>
        </div>
      </ng-container>

      <ng-template #ratingContentDesktop>
        <div
          class="relative w-20 h-20 md:w-24 md:h-24 lg:w-28 lg:h-28 flex items-center justify-center"
        >
          <svg
            width="100%"
            height="100%"
            viewBox="0 0 42 42"
            class="circular-chart absolute w-full h-full"
          >
            <defs>
              <linearGradient
                id="ratingGradientDesktop"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="0%"
              >
                <stop
                  offset="0%"
                  style="stop-color: #facc15; stop-opacity: 1"
                />
                <stop
                  offset="100%"
                  style="stop-color: #f59e0b; stop-opacity: 1"
                />
              </linearGradient>
            </defs>

            <!-- Background Circle -->
            <circle
              class="circle-bg"
              cx="21"
              cy="21"
              r="18"
              stroke-width="4"
              [attr.style]="
                isRatingLoaded &&
                !isDeleteLoading &&
                !isEditLoading &&
                !isCreateLoading &&
                getAverageRating() === 0
                  ? 'stroke-opacity: 0;'
                  : ''
              "
            />

            <!-- Foreground Circle (Rating Progress) -->
            <circle
              class="circle"
              cx="21"
              cy="21"
              r="18"
              stroke="url(#ratingGradientDesktop)"
              stroke-width="4"
              stroke-dasharray="113.1"
              [attr.stroke-dashoffset]="circleDashOffset"
              [attr.style]="
                getAverageRating() === 0 ? 'stroke-opacity: 0;' : ''
              "
              stroke-linecap="butt"
            />
          </svg>

          <!-- Rating Display OR No Reviews Message -->
          <span
            class="absolute inset-0 flex flex-col items-center justify-center text-white font-bold text-2xl md:text-3xl lg:text-4xl"
          >
            <ng-container
              *ngIf="
                isRatingLoaded &&
                  !isDeleteLoading &&
                  !isEditLoading &&
                  !isCreateLoading;
                else loadingSpinner
              "
            >
              <ng-container
                *ngIf="getAverageRating() > 0; else noReviewsMessage"
              >
                <ng-container
                  *ngIf="getAverageRating() === 10; else formattedRating"
                >
                  10
                </ng-container>
                <ng-template #formattedRating>
                  {{ getAverageRating() | number : "1.1-1" }}
                </ng-template>
                <span class="text-xs md:text-sm font-medium text-gray-300"
                  >/ 10</span
                >
              </ng-container>
            </ng-container>
          </span>
        </div>
      </ng-template>
    </div>

    <!-- No Reviews: Show Star Rating Prompt -->
    <ng-template #noReviewsMessage>
      <div class="flex flex-col items-center justify-center text-gray-400">
        <div class="flex space-x-1">
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
          <i class="far fa-star text-3xl"></i>
        </div>
        <span class="text-lg font-medium">Be the first to rate!</span>
      </div>
    </ng-template>

    <!-- Small Loader Inside Circle -->
    <ng-template #loadingSpinner>
      <div class="animate-pulse flex items-center justify-center">
        <i
          class="fas fa-spinner fa-spin text-gray-400 text-2xl md:text-3xl lg:text-4xl"
        ></i>
      </div>
    </ng-template>

    <div class="flex-1 min-h-0 flex flex-col pr-2 overflow-hidden">
      <!-- Two-Column Layout -->
      <div class="flex flex-row flex-1 min-h-0 gap-4 mt-2 overflow-hidden">
        <!-- Wrapper for both iPods -->
        <div
          class="relative flex-[1] max-w-[400px] h-[80vh] overflow-auto overflow-hidden"
        >
          <!-- First iPod -->
          <div
            class="relative transition-transform duration-500"
            [@iPodTransition]="iPodState"
            [ngClass]="{ 'invisible-view': showSecondIpod }"
          >
            <div
              class="bg-[#09101F] rounded-lg p-3 md:p-4 w-full overflow-hidden"
            >
              <div class="flex flex-col h-full">
                <!-- Image Area -->
                <div
                  class="relative flex-1 flex items-center justify-center w-full min-h-[200px] max-h-[60vh]"
                >
                  <!-- Image Wrapper (Matches Mobile Structure) -->
                  <div
                    class="relative w-full aspect-square flex items-center justify-center overflow-hidden rounded-lg"
                  >
                    <!-- Skeleton Loader -->
                    <div
                      *ngIf="!isImageLoaded"
                      class="absolute inset-0 flex items-center justify-center bg-gray-700 skeleton-wave rounded-lg"
                    ></div>

                    <!-- Actual Image (Fixed) -->
                    <img
                      *ngIf="isImageLoaded"
                      [src]="
                        record.type === 'Artist'
                          ? record.picture ||
                            'https://res.cloudinary.com/drbccjuul/image/upload/v1750168658/t74iybj36xjrifpp7wzc.png'
                          : record.cover ||
                            'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                      "
                      [alt]="
                        record.type === 'Artist' ? record.name : record.title
                      "
                      class="w-full h-full object-contain rounded-lg transition-transform duration-300 ease-in-out"
                    />
                  </div>
                </div>

                <!-- Info and Audio Player -->
                <div
                  class="flex flex-col items-center justify-center flex-1 pb-4 pt-2 w-full"
                >
                  <div
                    class="text-center text-2xl mb-4 text-gray-200 font-semibold w-full"
                  >
                    <ng-container *ngIf="record.type === 'Artist'">
                      <span class="text-gray-400 text-xl block uppercase mt-2">
                        Artist
                      </span>
                    </ng-container>
                    <ng-container *ngIf="record.type === 'Album'">
                      <span
                        class="text-gray-400 text-xl block uppercase mb-2"
                        *ngIf="isSingleAlbum"
                      >
                        Single
                      </span>
                      <span
                        class="text-gray-400 text-xl block uppercase mb-2"
                        *ngIf="
                          !isSingleAlbum && (record.tracklist?.length ?? 0) > 1
                        "
                      >
                        Album
                      </span>
                    </ng-container>
                    <div
                      class="title-wrapper"
                      [class.masked]="isTextOverflowing"
                      #scrollingWrapperDesktop
                    >
                      <div
                        class="title-content"
                        #scrollingContentDesktop
                        [class.scroll-animate]="isTextOverflowing"
                      >
                        <span
                          *ngIf="record.type !== 'Artist'"
                          class="inline-block align-middle mt-3"
                        >
                          {{ record.title }}
                        </span>
                        <span *ngIf="record.type === 'Artist'">
                          {{ record.name }}
                        </span>
                      </div>
                    </div>
                    <p
                      class="text-gray-400 flex items-center justify-center mt-2"
                    >
                      <span
                        *ngIf="isExplicit"
                        class="bg-gray-600 text-white text-base w-[1.5em] h-[1.5em] flex items-center justify-center font-bold rounded leading-none mr-1"
                      >
                        E
                      </span>
                      <span
                        class="truncate overflow-hidden text-base whitespace-nowrap max-w-full px-2"
                      >
                        {{ record.type !== "Artist" ? record.artist : "" }}
                      </span>
                    </p>
                  </div>
                  <div
                    class="h-auto flex items-end justify-center pb-[env(safe-area-inset-bottom)]"
                  >
                    <app-audio-player
                      class="pt-1"
                      *ngIf="record"
                      [record]="record"
                      [hidden]="showSecondIpod"
                      [showForwardAndBackwardButtons]="
                        showForwardAndBackwardButtons
                      "
                      #audioPlayerDesktop
                      (next)="nextSong()"
                      [song]="currentSong"
                      (previous)="prevSong()"
                      (playStatus)="updatePlayStatus($event)"
                      (playStarted)="onAudioPlayStarted($event)"
                      [currentIndex]="currentIndex"
                      [recordList]="recordList"
                    ></app-audio-player>
                  </div>
                  <!-- Add Artist Button -->
                  <div *ngIf="record.type == 'Artist'">
                    <button
                      *ngIf="!isProfileLoading && !isInList"
                      class="mt-4 w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-indigo-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
                      [disabled]="addingToList"
                      (click)="addToArtistList(record)"
                    >
                      <ng-container *ngIf="!addingToList; else addingState">
                        <i class="fas fa-plus-circle mr-2 text-2xl"></i>
                        Add Artist
                      </ng-container>
                    </button>

                    <!-- Remove Artist Button -->
                    <button
                      *ngIf="!isProfileLoading && isInList"
                      class="mt-4 w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-red-500 hover:bg-red-600 disabled:bg-gray-500 disabled:cursor-not-allowed"
                      [disabled]="addingToList"
                      (click)="removeFromArtistList(record)"
                    >
                      <ng-container *ngIf="!addingToList; else removingState">
                        <i class="fas fa-trash text-2xl mr-2"></i> Remove Artist
                      </ng-container>
                    </button>

                    <!-- Loading templates -->
                    <ng-template #addingState>
                      <i class="fas fa-spinner fa-spin mr-2"></i> Adding...
                    </ng-template>

                    <ng-template #removingState>
                      <i class="fas fa-spinner fa-spin mr-2"></i> Removing...
                    </ng-template>
                  </div>

                  <!-- Loading state while fetching smart link -->
                  <div
                    *ngIf="
                      isLoadingSmartUrl &&
                      !showSecondIpod &&
                      record.type !== 'Artist'
                    "
                    class="mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-medium py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gray-700 opacity-75 animate-pulse"
                  >
                    <i class="fas fa-spinner fa-spin mr-2 text-2xl"></i>
                    Loading link...
                  </div>

                  <!-- Actual smart link once available -->
                  <a
                    *ngIf="!isLoadingSmartUrl && smartLinkUrl"
                    [href]="smartLinkUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    (click)="openMusicAppClick($event)"
                    class="music-app-button mt-[2rem] mb-[1rem] w-auto mx-auto text-white font-bold py-2 px-6 rounded-full flex items-center justify-center text-lg bg-gradient-to-r from-sky-500 to-blue-600 hover:bg-indigo-600 transition"
                  >
                    <i class="fas fa-headphones mr-2 text-2xl"></i>
                    Open in Music App
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Back of iPod (Desktop) -->
          <div
            [@slideAnimation]="showSecondIpod ? 'back' : 'hidden'"
            [ngClass]="{ 'invisible-view': !showSecondIpod }"
            class="absolute inset-0 z-30 overflow-y-auto custom-scrollbar bg-[#09101F] rounded-lg max-h-[78vh]"
          >
            <!-- Artist Section -->
            <div *ngIf="record.type === 'Artist'">
              <div class="relative mt-[1.5rem] left-0 right-0 z-50">
                <div
                  class="relative flex bg-gray-800 rounded-full p-1 w-fit mx-auto mb-5 mt-2"
                >
                  <!-- Sliding Highlight -->
                  <div
                    class="absolute top-0 left-0 h-full bg-[#0F5EE4] rounded-full transition-all duration-300"
                    [ngStyle]="{
                      width: activeTab === 'Top Tracks' ? '50%' : '50%',
                      transform:
                        activeTab === 'All Releases'
                          ? 'translateX(100%)'
                          : 'translateX(0%)'
                    }"
                  ></div>

                  <!-- Top Tracks and All Releases Buttons -->
                  <button
                    class="relative z-10 w-32 py-1.5 text-base font-semibold rounded-full text-center transition"
                    [ngClass]="{
                      'text-white': activeTab === 'Top Tracks',
                      'text-gray-300': activeTab !== 'Top Tracks'
                    }"
                    (click)="activeTab = 'Top Tracks'"
                  >
                    Top Tracks
                  </button>

                  <button
                    class="relative z-10 w-32 py-1.5 text-base font-semibold rounded-full text-center transition"
                    [ngClass]="{
                      'text-white': activeTab === 'All Releases',
                      'text-gray-300': activeTab !== 'All Releases'
                    }"
                    (click)="activeTab = 'All Releases'"
                  >
                    All Releases
                  </button>
                </div>

                <!-- Top Tracks Tracklist -->
                <div *ngIf="activeTab === 'Top Tracks'" class="px-2">
                  <ul
                    *ngIf="isTracklistArray"
                    class="w-full mt-1 mb-2 rounded-lg space-y-3"
                  >
                    <li
                      *ngFor="let track of record.tracklist; let i = index"
                      class="flex items-center justify-between py-2 px-1 rounded-xl transition-all duration-300 bg-gray-800"
                      [ngClass]="{
                        'opacity-50':
                          !track.preview || track.preview.length <= 1,
                        'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
                      }"
                    >
                      <!-- Album Image -->
                      <div
                        class="relative w-[5rem] h-[5rem] flex-shrink-0 mr-2"
                      >
                        <!-- Spinner -->
                        <div
                          *ngIf="!isTrackImageLoaded(i)"
                          class="absolute inset-0 z-10 flex items-center justify-center bg-gray-900 border border-gray-600 rounded-md"
                        >
                          <div
                            class="w-5 h-5 border-t-2 border-white rounded-full animate-spin"
                          ></div>
                        </div>

                        <!-- Image -->
                        <img
                          (click)="openSongOrAlbum(track)"
                          (load)="markTrackImageLoaded(i)"
                          (error)="markTrackImageLoaded(i)"
                          [src]="
                            track.cover ||
                            'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                          "
                          [style.opacity]="isTrackImageLoaded(i) ? '1' : '0'"
                          class="w-full h-full object-cover rounded-md border-2 border-gray-500 transition-opacity duration-300"
                          alt="Album Cover"
                        />
                      </div>

                      <!-- Title and album info -->
                      <div
                        class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
                      >
                        <div class="flex items-center gap-2 min-w-0 text-xl">
                          <span
                            (click)="openSongOrAlbum(track)"
                            class="text-white text-base truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                          >
                            <span
                              *ngIf="track.isExplicit"
                              class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.2em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                            >
                              E
                            </span>
                            <span
                              class="pl-1 pr-2 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                              >{{ track.title }}</span
                            >
                          </span>
                        </div>
                        <div
                          (click)="openSongOrAlbum(track)"
                          class="flex items-center gap-2 text-gray-500 text-sm"
                        >
                          <span
                            class="truncate overflow-hidden whitespace-nowrap block flex-1 pr-2"
                            [ngClass]="{ 'pl-[.3rem]': !track.isExplicit }"
                          >
                            {{ track.album }}
                          </span>
                        </div>
                      </div>

                      <!-- Play Button -->
                      <ng-container
                        *ngIf="track.preview && track.preview.length > 1"
                      >
                        <div
                          class="flex items-center justify-center w-12 h-12 bg-gray-500 text-white rounded-full px-3 mr-1 transition-all duration-300"
                          [ngClass]="{
                            'transition-all duration-300 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                              track.isPlaying
                          }"
                          (click)="playTrack(track)"
                        >
                          <i
                            [ngClass]="{
                              fas: true,
                              'fa-pause': track.isPlaying,
                              'fa-play': !track.isPlaying
                            }"
                            class="text-lg transition-all duration-300"
                          >
                          </i>
                        </div>
                      </ng-container>
                    </li>
                  </ul>

                  <!-- Loading state -->
                  <div
                    *ngIf="isLoadingExtraDetails"
                    class="w-full bg-[#09101F] p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
                  >
                    <p class="text-gray-400 text-center mb-4">
                      Loading tracklist...
                    </p>
                    <div
                      class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
                    ></div>
                  </div>

                  <!-- No tracklist -->
                  <div
                    *ngIf="!isLoadingExtraDetails && !isTracklistArray"
                    class="w-full bg-gray-800 p-6 rounded-lg text-center"
                  >
                    <p class="text-gray-400">Top Tracks Unavailable</p>
                  </div>
                </div>
              </div>
              <!-- All Releases View -->
              <div *ngIf="activeTab === 'All Releases'" class="px-2">
                <div
                  class="grid grid-cols-2 gap-4 p-2 mb-2 rounded-lg"
                >
                  <div
                    *ngFor="let release of releases; let i = index"
                    class="text-center bg-gray-800 rounded-lg py-2"
                    (click)="openSongOrAlbum(release)"
                  >
                    <div
                      class="relative aspect-square w-full max-w-[8rem] mx-auto"
                    >
                      <!-- Spinner -->
                      <div
                        *ngIf="!isReleaseImageLoaded(i)"
                        class="absolute inset-0 z-10 flex items-center justify-center bg-gray-800 border border-gray-700 rounded-md"
                      >
                        <div
                          class="w-5 h-5 border-t-2 border-white rounded-full animate-spin"
                        ></div>
                      </div>

                      <!-- Image -->
                      <img
                        [src]="
                          release.cover ||
                          'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                        "
                        (load)="markReleaseImageLoaded(i)"
                        (error)="markReleaseImageLoaded(i)"
                        [style.opacity]="isReleaseImageLoaded(i) ? '1' : '0'"
                        class="aspect-square w-full object-cover rounded-md border-2 border-gray-500 transition-opacity duration-300"
                        alt="Release Cover"
                      />
                    </div>

                    <div class="mt-2 flex justify-center">
                      <span
                        *ngIf="release.isExplicit"
                        class="bg-gray-600 text-white mt-[.1rem] text-xs w-[1rem] h-[1rem] flex items-center justify-center font-bold rounded leading-none shrink-0 mr-1"
                      >
                        E
                      </span>

                      <!-- Container with max width and truncate behavior -->
                      <span
                        class="text-white font-semibold text-sm truncate overflow-hidden whitespace-nowrap max-w-[80%] block"
                        [title]="release.title"
                      >
                        {{ release.title }}
                      </span>
                    </div>

                    <p class="text-gray-400 text-xs">
                      {{ release.releaseDate | date : "yyyy" }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Album and Song Section  -->
            <div *ngIf="record.type !== 'Artist'">
              <div class="relative flex justify-center items-center">
                <img
                  [src]="
                    record.cover ||
                    'https://res.cloudinary.com/drbccjuul/image/upload/e_improve:outdoor/m2bmgchypxctuwaac801'
                  "
                  class="w-[55%] h-auto rounded-md mt-[1rem] border-2 border-gray-500"
                  alt="Record Image"
                />
              </div>
              <div class="px-2">
                <div
                  *ngIf="!isLoadingExtraDetails"
                  class="p-4 text-white w-full mt-[1rem] px-3 bg-gray-800 rounded-lg"
                >
                  <div class="text-2xl font-bold leading-snug mb-1">
                    {{ record.title }}
                  </div>
                  <div
                    *ngIf="record.type === 'Album'"
                    class="text-base text-gray-400 pt-1"
                  >
                    <div class="text-lg text-gray-400 pt-1">
                      Artist:
                      <span class="text-white">{{ record.artist }}</span>
                    </div>
                  </div>
                  <!-- Contributors -->
                  <div *ngIf="record.contributors?.length">
                    <div class="text-lg text-gray-400 pt-1">
                      Contributors:
                      <span class="text-white">{{
                        record.contributors?.join(", ")
                      }}</span>
                    </div>
                  </div>
                  <div class="text-lg text-gray-400 pt-1">
                    Released:
                    <span class="text-white">{{
                      formatDate(record.releaseDate)
                    }}</span>
                  </div>
                  <div
                    *ngIf="record.type === 'Song'"
                    class="text-lg text-gray-400 pt-1"
                  >
                    Album:
                    <span class="text-white">{{ record.album }}</span>
                  </div>
                  <div class="text-lg text-gray-400 pt-1">
                    Genre: <span class="text-white">{{ record.genre }}</span>
                  </div>

                  <div
                    *ngIf="record.type === 'Album'"
                    class="text-lg text-gray-400 pt-1"
                  >
                    <div class="text-gray-400 pt-1">
                      <ng-container
                        *ngIf="trackSummary?.count === 1; else multipleTracks"
                      >
                        Duration:
                      </ng-container>
                      <ng-template #multipleTracks>
                        <span class="text-white">{{
                          trackSummary?.count
                        }}</span>
                        {{ trackSummary?.count === 1 ? " song" : " songs" }} ·
                      </ng-template>
                      <span class="text-white">{{
                        trackSummary?.durationDisplay
                      }}</span>
                    </div>
                  </div>

                  <div
                    *ngIf="record.type === 'Song'"
                    class="text-lg text-gray-400 pt-1"
                  >
                    Duration:
                    <span class="text-white">
                      {{ getSongDurationDisplay(record) }}
                    </span>
                  </div>
                </div>
                <!-- Album Tracklist -->
                <ul
                  *ngIf="
                    isTracklistArray &&
                    record.type === 'Album' &&
                    record.tracklist &&
                    record.tracklist.length > 1
                  "
                  class="w-full mt-3 mb-3 space-y-3 rounded-lg"
                >
                  <li
                    *ngFor="let track of record.tracklist; let i = index"
                    class="flex items-center justify-between py-3 px-1 rounded-xl transition-all duration-300 bg-gray-800"
                    [ngClass]="{
                      'opacity-50': !track.preview || track.preview.length <= 1,
                      'shadow-[0_0_8px_rgba(59,130,246,0.5)]': track.isPlaying
                    }"
                  >
                    <!-- Play Button -->
                    <ng-container
                      *ngIf="track.preview && track.preview.length > 1"
                    >
                      <div
                        class="flex items-center justify-center w-12 h-12 bg-gray-500 text-white rounded-full mr-3 ml-1 px-3 transition-all duration-300"
                        [ngClass]="{
                          'transition-all duration-700 border border-[#1E3A8A] shadow-[0_0_6px_rgba(59,130,246,0.5)]':
                            track.isPlaying
                        }"
                        (click)="playTrack(track)"
                      >
                        <i
                          [ngClass]="{
                            fas: true,
                            'fa-pause': track.isPlaying,
                            'fa-play': !track.isPlaying
                          }"
                          class="text-xl transition-all duration-700"
                        >
                        </i>
                      </div>
                    </ng-container>

                    <!-- Title and album info -->
                    <div
                      class="flex flex-col gap-1 flex-1 min-w-0 text-left font-semibold"
                    >
                      <div class="flex items-center gap-2 min-w-0 text-xl">
                        <span
                          (click)="openSongOrAlbum(track)"
                          class="text-white text-lg truncate overflow-hidden whitespace-nowrap text-ellipsis flex-1 min-w-0 flex items-center gap-1"
                        >
                          <span
                            *ngIf="track.isExplicit"
                            class="bg-gray-600 text-white text-sm w-[1.2em] h-[1.3em] flex items-center justify-center font-bold rounded leading-none shrink-0"
                          >
                            E
                          </span>
                          <span
                            class="pl-1 truncate overflow-hidden whitespace-nowrap text-ellipsis"
                            >{{ track.title }}</span
                          >
                        </span>
                      </div>
                    </div>

                    <!-- Duration -->
                    <span
                      (click)="openSongOrAlbum(track)"
                      class="text-white bg-gray-500 text-base shrink-0 ml-2.5 p-1 px-1.5 rounded-md mr-2"
                    >
                      {{ formatDuration(track.duration) || "?" }}
                    </span>
                  </li>
                </ul>
                <!-- Loading state -->
                <div
                  *ngIf="isLoadingExtraDetails"
                  class="w-full bg-gray-800 p-6 rounded-lg flex flex-col items-center justify-center mt-[2rem]"
                >
                  <p class="text-gray-400 text-center mb-4 text-lg">
                    Loading...
                  </p>
                  <div
                    class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 border-opacity-50"
                  ></div>
                </div>

                <!-- No tracklist -->
                <div
                  *ngIf="
                    !isLoadingExtraDetails &&
                    !isTracklistArray &&
                    record.type === 'Album'
                  "
                  class="w-full bg-[#09101F] p-6 rounded-lg text-center"
                >
                  <p class="text-gray-400">No tracklist available.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Reviews section -->
        <div
          class="flex flex-col flex-1 min-h-0 bg-[#262729] shadow-md rounded-t-lg rounded-b-lg overflow-hidden"
        >
          <div
            class="sticky top-0 z-30 bg-[#000000] px-3 py-2 shadow-[rgba(0,0,0,0.2)_0px_2px_6px] rounded-t-lg"
          >
            <div class="relative w-full flex flex-col items-center">
              <!-- Center: Reviews Header -->
              <div
                class="flex justify-center mb-2 pb-2 border-b border-b-gray-500 w-full"
              >
                <h2 class="text-2xl font-semibold text-white">
                  Reviews
                  <span class="text-base text-gray-400 font-medium">
                    {{
                      combinedReviews.length > 0
                        ? "(" + combinedReviews.length + ")"
                        : ""
                    }}
                  </span>
                </h2>
              </div>

              <div class="w-full flex items-center justify-between pt-2">
                <!-- Left: Filter Button -->
                <div class="flex items-center">
                  <ng-container *ngIf="isFilterActive(); else filterButton">
                    <div
                      class="flex items-center gap-2 text-amber-400 font-semibold"
                    >
                      <i class="fas fa-filter text-lg ml-2"></i>
                      <span class="capitalize text-lg"
                        >Filtered: {{ activeFilter }}</span
                      >
                      <button
                        (click)="clearFilter()"
                        class="text-gray-300 hover:text-white transition"
                        aria-label="Clear Filter"
                      >
                        <i class="fas fa-times-circle"></i>
                      </button>
                    </div>
                  </ng-container>

                  <ng-template #filterButton>
                    <button
                      (click)="toggleFilterMenu()"
                      [disabled]="combinedReviews.length <= 1"
                      class="flex items-center gap-1 text-lg font-semibold"
                      [ngClass]="{
                        'text-amber-400': combinedReviews.length > 1,
                        'text-white': combinedReviews.length <= 1
                      }"
                    >
                      <i class="fas fa-filter text-lg mr-1 ml-2"></i>
                      <span>Filter</span>
                    </button>
                  </ng-template>
                </div>

                <!-- Right: Add Button -->
                <div *ngIf="!isAddingReview && isReviewsLoaded">
                  <button
                    [disabled]="existingUserReview"
                    (click)="toggleReviewForm()"
                    [ngClass]="{
                      'bg-gradient-to-r from-sky-500 to-blue-600 text-white': !existingUserReview,
                      'bg-gray-500 text-gray-300': existingUserReview
                    }"
                    class="flex items-center gap-1 px-3 py-1 rounded-md font-medium"
                  >
                    <i class="fas fa-plus-circle text-lg mr-1"></i>
                    <span>Add</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <ng-template #loadingReviews>
            <div class="space-y-3 mt-3 px-3 pb-3">
              <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
              <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
              <div class="animate-pulse bg-gray-700 p-4 rounded-lg h-16"></div>
            </div>
          </ng-template>

          <ng-container *ngIf="isReviewsLoaded; else loadingReviews">
            <!-- Fullscreen Overlay for Creating -->
            <div
              *ngIf="isAddingReview"
              @overlayAnimation
              class="fixed inset-0 bg-gradient-to-br from-black/30 to-black/70 backdrop-blur-sm z-50 flex items-center justify-center"
            >
              <div
                class="bg-[#1c2127] shadow-xl border border-white/5 flex flex-col items-center justify-between w-[90vw] max-w-2xl min-h-[40rem] p-3 rounded-2xl"
              >
                <!-- Header with Back Button -->
                <div
                  class="relative w-full h-[64px] flex items-center justify-center px-4"
                >
                    <button
                    [disabled]="isCreateLoading"
                    (click)="cancelReview()"
                    class="w-14 h-14 flex items-center justify-center absolute left-4 rounded-full hover:bg-[#2d323a]"
                    >
                    <i class="fas fa-times text-3xl text-white"></i>
                    </button>

                  <p class="text-white font-semibold text-3xl text-center mt-[2rem]">
                    Write Review
                  </p>
                </div>

                <!-- Rating Section -->
                <div
                  class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden items-center"
                >
                  <div class="w-full max-w-[640px] text-center mx-auto">
                    <!-- Star Rating Display -->
                    <div class="flex justify-center mb-4 gap-0.5">
                      <ng-container
                        *ngFor="let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                      >
                        <ng-container [ngSwitch]="getStarType(star, newRating)">
                          <i
                            *ngSwitchCase="'full'"
                            class="fas fa-star text-3xl text-yellow-400"
                          ></i>
                          <i
                            *ngSwitchCase="'half'"
                            class="fas fa-star-half-alt text-3xl text-yellow-400"
                          ></i>
                          <i
                            *ngSwitchCase="'empty'"
                            class="far fa-star text-3xl text-gray-500"
                          ></i>
                        </ng-container>
                      </ng-container>
                    </div>

                    <p class="text-white font-medium text-2xl mb-2 text-center">
                      Rating:
                      <input
                        type="number"
                        min="0"
                        max="10"
                        step="0.1"
                        [(ngModel)]="newRating"
                        (keypress)="onKeyPressRating($event, 'new')"
                        (blur)="onBlurRating('new')"
                        class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-[#2d323a] border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                      />
                      <span
                        class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                        >/ 10</span
                      >
                    </p>

                    <!-- Slider -->
                    <input
                      type="range"
                      min="0"
                      max="10"
                      step="0.1"
                      [(ngModel)]="newRating"
                      [style.background]="getSliderBackground(newRating)"
                      class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern my-5"
                    />
                  </div>


              <!-- Textarea -->
              <div class="w-full max-w-[800px] flex-grow flex flex-col min-h-0">
                <textarea
                  [(ngModel)]="newReview"
                  [disabled]="isCreateLoading"
                  class="w-full flex-grow min-h-0 p-4 text-xl bg-[#14171a] rounded-xl text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                  placeholder="Leave your feedback..."
                  style="height:100%;"
                ></textarea>
              </div>

                  <!-- Submit Button -->
                  <div
                    class="flex font-medium w-full mt-[2rem] pb-3 max-w-[640px]"
                  >
                    <button
                      [disabled]="isCreateLoading"
                      (click)="submitReview()"
                      class="bg-gradient-to-r from-sky-500 to-blue-600 text-2xl px-4 py-4 rounded-2xl text-white w-full flex items-center justify-center gap-2 hover:brightness-110 hover:shadow-md transition duration-150"
                    >
                      <ng-container *ngIf="!isCreateLoading">
                        <i class="fas fa-paper-plane"></i> Create
                      </ng-container>
                      <ng-container *ngIf="isCreateLoading">
                        <i class="fas fa-spinner fa-spin"></i> Creating
                      </ng-container>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- All Reviews Section -->
            <ng-container
              *ngIf="
                existingUserReview || filteredReviews.length > 0;
                else noReviewsDesktop
              "
            >
              <div
                class="flex flex-col flex-1 min-h-0 overflow-hidden bg-[#262729] rounded-b-lg"
              >
                <ul
                  #reviewsSectionDesktop
                  class="flex-1 min-h-0 overflow-y-auto custom-scrollbar pt-0"
                  @fadeIn
                >
                  <li
                    *ngFor="
                      let review of pagedReviews;
                      let i = index;
                      trackBy: trackById
                    "
                    class="review-card p-2 flex flex-col relative bg-[#171a21]"
                    [ngClass]="{
                      'border-b border-gray-500': i < pagedReviews.length - 1
                    }"
                  >
                    <!-- Fullscreen Overlay for Editing -->
            <div
              *ngIf="isEditingReview"
              @overlayAnimation
              class="fixed inset-0 bg-gradient-to-br from-black/30 to-black/70 backdrop-blur-sm z-50 flex items-center justify-center"
            >
              <div
                class="bg-[#1c2127] shadow-xl border border-white/5 flex flex-col items-center justify-between w-[90vw] max-w-2xl min-h-[40rem] p-3 rounded-2xl"
              >
                <!-- Header with Back Button -->
                <div
                  class="relative w-full h-[64px] flex items-center justify-center px-4"
                >
                    <button
                    [disabled]="isEditLoading"
                    (click)="cancelEditReview()"
                    class="w-14 h-14 flex items-center justify-center absolute left-4 rounded-full hover:bg-[#2d323a]"
                    >
                    <i class="fas fa-times text-3xl text-white"></i>
                    </button>

                  <p class="text-white font-semibold text-3xl text-center mt-[2rem]">
                    Edit Review
                  </p>
                </div>

                        <!-- Edit Rating Section -->
                        <div
                          class="flex flex-col flex-grow w-full px-4 pt-4 overflow-hidden items-center"
                        >
                          <div class="w-full max-w-[640px] text-center mx-auto">
                            <!-- Star Rating Display -->
                            <div class="flex justify-center mb-4 gap-0.5">
                              <ng-container
                                *ngFor="
                                  let star of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                                "
                              >
                                <ng-container
                                  [ngSwitch]="getStarType(star, editedRating)"
                                >
                                  <i
                                    *ngSwitchCase="'full'"
                                    class="fas fa-star text-3xl text-yellow-400"
                                  ></i>
                                  <i
                                    *ngSwitchCase="'half'"
                                    class="fas fa-star-half-alt text-3xl text-yellow-400"
                                  ></i>
                                  <i
                                    *ngSwitchCase="'empty'"
                                    class="far fa-star text-3xl text-gray-500"
                                  ></i>
                                </ng-container>
                              </ng-container>
                            </div>

                            <p
                              class="text-white font-medium text-2xl mb-2 text-center"
                            >
                              Rating:
                              <input
                                type="number"
                                min="0"
                                max="10"
                                step="0.1"
                                [(ngModel)]="editedRating"
                                (keypress)="onKeyPressRating($event, 'edit')"
                                (blur)="onBlurRating('edit')"
                                class="w-[3.4rem] text-[1.8rem] leading-none text-yellow-400 bg-[#2d323a] border border-gray-600 text-center focus:outline-none focus:ring-2 focus:ring-indigo-500 px-0.5 rounded mr-2"
                              />
                              <span
                                class="text-gray-300 text-[1.5rem] opacity-70 font-medium"
                                >/ 10</span
                              >
                            </p>

                            <!-- Slider Control -->
                            <input
                              type="range"
                              min="0"
                              max="10"
                              step="0.1"
                              [(ngModel)]="editedRating"
                              [style.background]="
                                getSliderBackground(editedRating)
                              "
                              class="w-full h-3 rounded-full appearance-none cursor-pointer transition-all slider-modern my-5"
                            />
                          </div>

              <!-- Textarea -->
              <div class="w-full max-w-[800px] flex-grow flex flex-col min-h-0">
                <textarea
                  [(ngModel)]="editedReviewText"
                  [disabled]="isEditLoading"
                  class="w-full flex-grow min-h-0 p-4 text-xl bg-[#14171a] rounded-xl text-gray-300 placeholder-gray-500 focus:outline-none resize-none border border-gray-600"
                  placeholder="Leave your feedback..."
                  style="height:100%;"
                ></textarea>
              </div>
                  <!-- Submit Button -->
                  <div
                    class="flex font-medium w-full mt-[2rem] pb-3 max-w-[640px]"
                  >
                            <button
                              [disabled]="isEditLoading"
                              (click)="submitEditReview()"
                              class="bg-gradient-to-r from-sky-500 to-blue-600 text-2xl px-4 py-4 rounded-2xl text-white w-full flex items-center justify-center gap-2 hover:brightness-110"
                            >
                              <ng-container *ngIf="!isEditLoading">
                                <i class="fas fa-save mr-1"></i> Save
                              </ng-container>
                              <ng-container *ngIf="isEditLoading">
                                <i class="fas fa-spinner fa-spin mr-1"></i>
                                Saving
                              </ng-container>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <ng-container
                      *ngIf="
                        !(
                          existingUserReview &&
                          review._id === existingUserReview._id &&
                          isDeleteLoading
                        );
                        else deletingReviewLoaderMobile
                      "
                    >
                      <!-- Edit/Delete Buttons for User's Review -->
                      <ng-container
                        *ngIf="
                          existingUserReview &&
                          review._id === existingUserReview._id &&
                          !isEditingReview
                        "
                      >
                        <button
                          (click)="toggleEditReview(review)"
                          class="absolute bottom-3.5 right-[1rem] text-gray-400 transition"
                        >
                          <i class="fas fa-edit text-2xl"></i>
                        </button>
                        <button
                          (click)="showdeleteConfirmation(review)"
                          class="absolute bottom-3.5 left-[1rem] text-gray-400 transition"
                        >
                          <i class="fas fa-trash text-[1.3rem]"></i>
                        </button>
                      </ng-container>

                      <div class="flex items-start mt-[1rem]">
                        <!-- Profile Picture -->
                        <img
                          [src]="
                            review.user.profilePicture
                              ? transformCloudinaryUrl(
                                  review.user.profilePicture
                                )
                              : 'assets/user.png'
                          "
                          alt="Profile Picture"
                          (click)="goToProfile(review.user._id)"
                          class="w-[4rem] h-[4rem] rounded-full object-cover"
                        />

                        <!-- Username and Review Info -->
                        <div class="ml-3 flex-1">
                          <p
                            class="text-white text-lg textFixUsername font-medium pr-[.8rem]"
                          >
                            {{
                              existingUserReview &&
                              review._id === existingUserReview._id
                                ? "Your Review"
                                : review.user.username
                            }}
                          </p>
                          <p class="text-gray-400 text-sm textFixCreatedAtDate">
                            {{ review.createdAt | date : "short" }}
                          </p>
                        </div>

                        <!-- Rating Badge -->
                        <p
                          class="rating-badge text-white text-lg rounded-md px-3 py-1.5 text-center"
                          style="width: 6.95rem"
                        >
                          <i class="fas fa-star text-yellow-400"></i>
                          {{ review.rating }} / 10
                        </p>
                      </div>

                      <!-- Review Text -->
                      <div
                        class="mt-3 px-2"
                        [ngClass]="{
                          'pb-[4rem]':
                            existingUserReview &&
                            review._id === existingUserReview._id
                        }"
                      >
                        <!-- Review Text + Like Button Aligned -->
                        <div class="mt-3 px-2">
                          <p
                            class="text-white text-lg break-words"
                            *ngIf="
                              review.reviewText &&
                                review.reviewText.trim().length > 0;
                              else noReviewText
                            "
                          >
                            {{ review.reviewText }}
                          </p>
                          <ng-template #noReviewText>
                            <p
                              class="text-gray-400 italic text-base md:text-xl mt-2 font-serif"
                            >
                              “ No review written ”
                            </p>
                          </ng-template>

                          <div class="flex justify-end mt-2 px-1 pb-2">
                            <button
                              (click)="toggleLike(review)"
                              class="flex items-center space-x-2 px-3 py-1 bg-gray-800 rounded-full hover:bg-gray-700 transition border border-gray-600"
                            >
                              <svg
                                xmlns="http://www.w3.org/2000/svg"
                                [attr.fill]="
                                  review.likedByCurrentUser
                                    ? '#ec4899'
                                    : 'white'
                                "
                                viewBox="0 0 24 24"
                                class="w-5 h-5 transition-transform duration-300 ease-out"
                                [ngClass]="
                                  animateHeart[review._id] ? 'scale-125' : ''
                                "
                              >
                                <path
                                  d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 
                                        2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 
                                        C13.09 3.81 14.76 3 16.5 3c3.08 0 5.5 2.42 5.5 5.5 
                                        0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                                />
                              </svg>

                              <span
                                class="font-semibold text-base text-yellow-400"
                              >
                                {{ review.likes }}
                              </span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </ng-container>

                    <ng-template #deletingReviewLoaderMobile>
                      <div
                        class="flex items-center justify-center h-16 bg-gray-800 rounded-lg p-4"
                      >
                        <i
                          class="fas fa-spinner fa-spin text-gray-400 text-xl"
                        ></i>
                        <span class="ml-2 text-gray-300 text-lg"
                          >Deleting...</span
                        >
                      </div>
                    </ng-template>
                  </li>
                </ul>
                <div
                  class="px-4 py-3 bg-[#1e1f22] rounded-b-md text-base text-white flex flex-col items-center"
                  *ngIf="totalPages > 1"
                >
                  <span class="mb-2 font-medium text-base text-gray-400"
                    >Page</span
                  >
                  <div class="flex gap-2">
                    <button
                      *ngFor="
                        let p of [].constructor(totalPages);
                        let i = index
                      "
                      (click)="changePage(i + 1)"
                      [ngClass]="{
                        'bg-indigo-600': page === i + 1,
                        'bg-gray-600': page !== i + 1
                      }"
                      class="px-3 py-1 rounded text-sm font-medium text-white transition"
                    >
                      {{ i + 1 }}
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #noReviewsDesktop>
              <p class="text-gray-400 mt-8 pb-5 text-center text-xl">
                No reviews yet.
              </p>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- App Picker Modal -->
<div
  *ngIf="showAppPickerModal"
  class="fixed inset-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4"
>
  <div class="bg-[#1a1a1a] rounded-xl shadow-lg p-6 w-full max-w-xl relative">
    <!-- Close button -->
    <button
      class="absolute top-3 right-3 text-gray-400 hover:text-white text-4xl"
      (click)="showAppPickerModal = false"
    >
      &times;
    </button>

    <!-- Preferred App Section (your existing UI) -->
    <div class="w-full mx-auto mb-6">
      <h2 class="block text-xl md:text-2xl font-semibold py-2 text-center">
        <span class="text-gray-300">Select a Music App</span>
      </h2>

      <div class="flex justify-center pb-3 pt-3">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-5">
          <button
            *ngFor="let app of availablePlatforms"
            (click)="setPreferredMusicApp(app)"
            [ngStyle]="{
              backgroundColor:
                preferredApp === app
                  ? platformStyles[app].color
                  : shadeColor(platformStyles[app].color, -30)
            }"
            [ngClass]="{
              'text-white ring-2 ring-offset-1': preferredApp === app,
              'text-gray-100 opacity-90 hover:opacity-100': preferredApp !== app
            }"
            class="py-2 px-4 min-w-[6.5rem] rounded-full text-sm font-medium transition duration-200 focus:outline-none flex items-center gap-2 justify-center"
          >
            <ng-container *ngIf="platformStyles[app].icon; else svgIcon">
              <i
                [class]="platformStyles[app].icon"
                class="text-[2rem] leading-none"
              ></i>
            </ng-container>

            <ng-template #svgIcon>
              <img
                *ngIf="platformStyles[app].imagePath"
                [src]="platformStyles[app].imagePath"
                alt="{{ platformStyles[app].label }} logo"
                class="w-[2rem] h-[2rem]"
              />
            </ng-template>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
